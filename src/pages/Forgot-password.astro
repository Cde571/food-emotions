---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Recuperar contrase√±a">
  <section class="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#425638] via-[#556844] to-[#687450] px-6 py-10">

    <div class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl shadow-black/20 border border-white/20">

      <h1 class="text-3xl font-bold text-white mb-4">¬øOlvidaste tu contrase√±a?</h1>
      <p class="text-white/80 mb-6">Ingresa tu correo o tel√©fono y te enviaremos un c√≥digo OTP.</p>

      <!-- Tabs para elegir m√©todo -->
      <div class="flex gap-2 mb-6">
        <button
          id="emailTab"
          class="flex-1 py-2 rounded-lg bg-white/30 text-white font-semibold transition active"
        >
          Correo
        </button>
        <button
          id="phoneTab"
          class="flex-1 py-2 rounded-lg bg-white/10 text-white/60 font-semibold transition"
        >
          Tel√©fono
        </button>
      </div>

      <form id="forgotForm" class="flex flex-col gap-4">
        <!-- Campo de email -->
        <div id="emailField">
          <input
            type="email"
            name="email"
            id="emailInput"
            placeholder="Correo electr√≥nico"
            class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/50 focus:bg-white/30 outline-none"
          />
        </div>

        <!-- Campo de tel√©fono (oculto por defecto) -->
        <div id="phoneField" class="hidden">
          <input
            type="tel"
            name="telefono"
            id="phoneInput"
            placeholder="Tel√©fono (ej: +573001234567)"
            class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/50 focus:bg-white/30 outline-none"
          />
        </div>

        <button
          type="submit"
          class="w-full py-3 rounded-xl bg-[#687450] hover:bg-[#79885C] text-white font-semibold transition"
        >
          Enviar c√≥digo OTP
        </button>

        <a href="/login" class="text-center text-white/70 hover:text-white text-sm">
          Volver al inicio de sesi√≥n
        </a>
      </form>
    </div>

  </section>

  <script>
    // Configuraci√≥n: cambia esto seg√∫n tu entorno
    const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';

    let currentMethod = 'email';

    // Manejo de tabs
    const emailTab = document.getElementById('emailTab');
    const phoneTab = document.getElementById('phoneTab');
    const emailField = document.getElementById('emailField');
    const phoneField = document.getElementById('phoneField');
    const emailInput = document.getElementById('emailInput');
    const phoneInput = document.getElementById('phoneInput');

    emailTab.addEventListener('click', () => {
      currentMethod = 'email';
      emailTab.classList.add('bg-white/30', 'text-white');
      emailTab.classList.remove('bg-white/10', 'text-white/60');
      phoneTab.classList.remove('bg-white/30', 'text-white');
      phoneTab.classList.add('bg-white/10', 'text-white/60');
      
      emailField.classList.remove('hidden');
      phoneField.classList.add('hidden');
      emailInput.required = true;
      phoneInput.required = false;
    });

    phoneTab.addEventListener('click', () => {
      currentMethod = 'phone';
      phoneTab.classList.add('bg-white/30', 'text-white');
      phoneTab.classList.remove('bg-white/10', 'text-white/60');
      emailTab.classList.remove('bg-white/30', 'text-white');
      emailTab.classList.add('bg-white/10', 'text-white/60');
      
      phoneField.classList.remove('hidden');
      emailField.classList.add('hidden');
      phoneInput.required = true;
      emailInput.required = false;
    });

    // Env√≠o del formulario
    document.getElementById('forgotForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {};
      
      if (currentMethod === 'email') {
        payload.email = emailInput.value;
      } else {
        payload.telefono = phoneInput.value;
      }

      console.log('üîç Enviando a:', `${API_URL}/api/auth/send-otp`);
      console.log('üì¶ Payload:', payload);

      try {
        const res = await fetch(`${API_URL}/api/auth/send-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        console.log('üì° Status:', res.status);
        const data = await res.json();
        console.log('üìÑ Response:', data);

        if (res.ok) {
          alert(data.message);
          // Redirige con el par√°metro correcto
          const queryParam = currentMethod === 'email' 
            ? `email=${encodeURIComponent(payload.email)}`
            : `telefono=${encodeURIComponent(payload.telefono)}`;
          window.location.href = `/verify-otp?${queryParam}`;
        } else {
          alert(data.message || 'Error al enviar el c√≥digo');
        }
      } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error de conexi√≥n. Verifica que el servidor est√© corriendo en http://localhost:3000');
      }
    });
  </script>

  <style>
    .active {
      background-color: rgba(255, 255, 255, 0.3);
    }
  </style>
</Layout>