---
// src/pages/Social.astro
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/shared/Navigation.astro';
import Stories from '../components/social/Stories.astro';
import Post from '../components/social/Post.astro';
import SuggestedUsers from '../components/social/SuggestedUsers.astro';
import PostModal from '../components/social/PostModal.astro';
import { savePost, sharePost, deletePost } from '../scripts/api/posts.js';
import { toggleLike } from '../scripts/api/likes.js';
import SearchBar from '../components/social/SearchBar.astro';

// Obtener la ruta actual
const currentPath = Astro.url.pathname;
const showNavigation = currentPath === '/Social' || currentPath === '/Social/';
---

<Layout title="Social Feed">
  {showNavigation && <Navigation />}
  
  <div class="social-layout" data-show-nav={showNavigation}>
    <!-- Sidebar Izquierda: Navegaci√≥n -->
    <aside class="sidebar-left">
      <div class="user-profile-card">
        <div class="profile-header">
          <img id="profile-pic" src="" alt="Profile" class="profile-avatar" />
          <div class="profile-badge"></div>
        </div>
        <h3 id="user-name" class="profile-name">Cargando...</h3>
        <p id="user-username" class="profile-handle">@username</p>
        
        <div class="profile-stats">
          <div class="stat-item">
            <span class="stat-number" id="posts-count">0</span>
            <span class="stat-label">Posts</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="followers-count">0</span>
            <span class="stat-label">Seguidores</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="following-count">0</span>
            <span class="stat-label">Siguiendo</span>
          </div>
        </div>
      </div>

      <nav class="main-navigation">
        <a href="/Social" class="nav-link active">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="14" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/>
          </svg>
          <span>Feed</span>
        </a>
        <a href="/Explore" class="nav-link">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
          </svg>
          <span>Explorar</span>
        </a>
        <a href="/Messages" class="nav-link">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
          </svg>
          <span>Mensajes</span>
          <span class="notification-badge hidden" id="messages-badge">0</span>
        </a>
        <a href="/Notifications" class="nav-link">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 01-3.46 0"/>
          </svg>
          <span>Notificaciones</span>
          <span class="notification-badge hidden" id="notif-badge">0</span>
        </a>
        <a href="/Saved" class="nav-link">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>
          </svg>
          <span>Guardados</span>
        </a>
        <a href="/Profile" class="nav-link">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <span>Mi Perfil</span>
        </a>
      </nav>

      <button id="create-post-btn" class="create-post-btn">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Crear Publicaci√≥n
      </button>
    </aside>

    <!-- Contenido Principal -->
    <main class="main-content">
      <!-- Stories Section -->
      <section class="stories-section">
        <h2 class="section-title">Historias</h2>
        <Stories />
      </section>

      <!-- Quick Post -->
      <div class="quick-post-card">
        <img id="quick-post-avatar" src="" alt="Avatar" class="quick-avatar" />
        <button id="quick-post-input" class="quick-input">
          Comparte algo interesante...
        </button>
        <div class="quick-actions">
          <button class="quick-action-btn" title="Foto/Video">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </button>
          <button class="quick-action-btn" title="Sentimiento">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
              <line x1="9" y1="9" x2="9.01" y2="9"/>
              <line x1="15" y1="9" x2="15.01" y2="9"/>
            </svg>
          </button>
          <button class="quick-action-btn" title="Ubicaci√≥n">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Search Users -->
      <section class="search-section">
        <SearchBar />
      </section>

      <!-- Filter Tabs -->
      <div class="filter-tabs">
        <button class="tab active" data-filter="all">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="8" y1="6" x2="21" y2="6"/>
            <line x1="8" y1="12" x2="21" y2="12"/>
            <line x1="8" y1="18" x2="21" y2="18"/>
            <line x1="3" y1="6" x2="3.01" y2="6"/>
            <line x1="3" y1="12" x2="3.01" y2="12"/>
            <line x1="3" y1="18" x2="3.01" y2="18"/>
          </svg>
          Todo
        </button>
        <button class="tab" data-filter="following">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 00-3-3.87"/>
            <path d="M16 3.13a4 4 0 010 7.75"/>
          </svg>
          Siguiendo
        </button>
        <button class="tab" data-filter="trending">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
            <polyline points="17 6 23 6 23 12"/>
          </svg>
          Tendencias
        </button>
      </div>

      <!-- Posts Feed -->
      <div id="posts-feed" class="posts-grid">
        <div class="loading-state">
          <div class="loader"></div>
          <p>Cargando publicaciones...</p>
        </div>
      </div>

      <div id="scroll-trigger"></div>
    </main>

    <!-- Sidebar Derecha -->
    <aside class="sidebar-right">
      <!-- Trending Topics -->
<div class="widget trending-widget">
  <div class="widget-header">
    <h3 class="widget-title">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 4h16v2H4zm0 6h16v2H4zm0 6h16v2H4z"/>
      </svg>
      Tendencias de comida
    </h3>

    <!-- Bot√≥n para recargar recetas -->
    <button id="refresh-recipes" class="refresh-btn" title="Actualizar">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 4 23 10 17 10"/>
        <polyline points="1 20 1 14 7 14"/>
        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
      </svg>
    </button>
  </div>

  <!-- üü¢ Aqu√≠ se cargan las recetas -->
  <div id="trending-list" class="trending-list">
    <p class="loading-text">Cargando recetas...</p>
  </div>
</div>


      <!-- Suggested Users -->
    <div class="widget suggestions-widget">
      <div class="widget-header">
        <h3 class="widget-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
          </svg>
          Sugerencias
        </h3>

    <!-- Bot√≥n actualizar -->
    <button class="refresh-btn" id="refresh-suggestions" title="Actualizar">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 4 23 10 17 10"/>
        <polyline points="1 20 1 14 7 14"/>
        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
      </svg>
    </button>
  </div>

  <!-- üî• Aqu√≠ se insertan los usuarios sugeridos -->
  <div id="suggested-users" class="suggested-users-list">
    <p class="loading-text">Cargando...</p>
  </div>
</div>

      <!-- ‚ú® MINI REPRODUCTOR DE YOUTUBE -->
<div class="widget youtube-player-widget">
  <div class="player-header">
    <h3 class="widget-title">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
        <path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
      </svg>
      M√∫sica
    </h3>
    <button class="player-toggle-btn" id="yt-toggle" title="Minimizar">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
        <path d="M19 13H5v-2h14v2z"/>
      </svg>
    </button>
  </div>
  
  <div class="player-content" id="yt-player-content">
    <!-- B√∫squeda -->
    <div class="player-search">
      <input type="text" 
             class="player-search-input" 
             placeholder="Buscar m√∫sica..." 
             id="yt-search-input" />
      <button class="player-search-btn" id="yt-search-btn">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
      </button>
    </div>
    
    <!-- Playlist -->
    <div class="player-playlist" id="yt-playlist">
      <p class="player-empty">üéµ Busca m√∫sica para comenzar</p>
    </div>
    
    <!-- Video actual -->
    <div class="player-current hidden" id="yt-current">
      <div class="current-info">
        <img src="" alt="Thumbnail" class="current-thumbnail" id="yt-thumbnail" />
        <div class="current-details">
          <h4 class="current-title" id="yt-title">-</h4>
          <p class="current-channel" id="yt-channel">-</p>
        </div>
      </div>
      
      <!-- Controles -->
      <div class="player-controls">
        <button class="control-btn" id="yt-prev" title="Anterior" disabled>
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
          </svg>
        </button>
        <button class="control-btn control-play" id="yt-play" title="Reproducir">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </button>
        <button class="control-btn" id="yt-next" title="Siguiente" disabled>
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
          </svg>
        </button>
        <button class="control-btn" id="yt-stop" title="Detener">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <rect x="6" y="6" width="12" height="12"/>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Contenedor del iframe -->
    <div class="player-iframe-container hidden" id="yt-iframe-container">
      <iframe
    id="yt-iframe"
    class="yt-iframe"
    width="100%"
    height="200"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen
  ></iframe>
    </div>
  </div>
</div>

<!-- Quick Stats -->
<div class="widget stats-widget">
  <h3 class="widget-title">Tu Actividad</h3>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üëÅÔ∏è</div>
      <div class="stat-data">
        <span class="stat-value">2.5K</span>
        <span class="stat-name">Vistas</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚ù§Ô∏è</div>
      <div class="stat-data">
        <span class="stat-value">856</span>
        <span class="stat-name">Likes</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üí¨</div>
      <div class="stat-data">
        <span class="stat-value">124</span>
        <span class="stat-name">Comentarios</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üì§</div>
      <div class="stat-data">
        <span class="stat-value">43</span>
        <span class="stat-name">Compartidos</span>
      </div>
    </div>
  </div>
</div>

</aside>
</div>

<PostModal />

  <!-- Toast Notification -->
  <div id="toast" class="toast-notification hidden">
    <div class="toast-icon"></div>
    <div class="toast-content">
      <p class="toast-message"></p>
    </div>
    <button class="toast-close">√ó</button>
  </div>
</Layout>

<script>
  // ============================================================
  // üîß CONFIGURACI√ìN Y ESTADO GLOBAL
  // ============================================================
  const API_URL = 'http://localhost:3000';
  
  let currentPage = 1;
  let isLoading = false;
  let hasMore = true;
  let currentFilter = 'all';
  let currentUser = null;

  // ============================================================
  // üë§ CARGAR DATOS DEL USUARIO CON STATS
  // ============================================================
  async function loadUserData() {
    try {
      console.log('üîÑ Cargando datos del usuario...');
      
      const response = await fetch(`${API_URL}/api/user/me`, {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const user = await response.json();
      console.log('‚úÖ Usuario cargado:', user);

      if (!user.loggedIn) {
        window.location.href = '/login';
        return;
      }

      currentUser = user;

      // Actualizar avatar y nombre
      const avatarUrl = user.profilePic || 
        `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=667BC6&color=fff`;
      
      const profilePic = document.getElementById('profile-pic');
      const quickAvatar = document.getElementById('quick-post-avatar');
      const userName = document.getElementById('user-name');
      const userUsername = document.getElementById('user-username');

      if (profilePic) profilePic.src = avatarUrl;
      if (quickAvatar) quickAvatar.src = avatarUrl;
      if (userName) userName.textContent = user.username;
      if (userUsername) userUsername.textContent = `@${user.username}`;

      // ‚≠ê ACTUALIZAR STATS (sidebar izquierdo)
      if (user.stats) {
        console.log('üìä Stats recibidas:', user.stats);
        
        const postsCount = document.getElementById('posts-count');
        const followersCount = document.getElementById('followers-count');
        const followingCount = document.getElementById('following-count');

        if (postsCount) postsCount.textContent = user.stats.posts || 0;
        if (followersCount) followersCount.textContent = user.stats.followers || 0;
        if (followingCount) followingCount.textContent = user.stats.following || 0;
      }

      // Cargar widget de actividad
      loadActivityStats();

      // Cargar notificaciones
      loadNotifications();

      return user;
    } catch (error) {
      console.error('‚ùå Error cargando usuario:', error);
      showToast('Error al cargar datos del usuario', 'error');
      return null;
    }
  }

// ============================================================
// üéµ MINI REPRODUCTOR DE YOUTUBE - VERSI√ìN SIMPLIFICADA IFRAME
// ============================================================
const YOUTUBE_API_KEY = "AIzaSyCucqrSvOnDJvGkjNjzoRJWjto0xOHpRDc";

async function searchYouTubeVideos(query) {
  try {
    const params = new URLSearchParams({
      part: "snippet",
      type: "video",
      videoCategoryId: "10",
      maxResults: "6",
      q: query,
      key: YOUTUBE_API_KEY,
    });

    const url = `https://www.googleapis.com/youtube/v3/search?${params.toString()}`;

    const res = await fetch(url);
    const data = await res.json();

    if (!res.ok) throw new Error(data.error?.message || "Error en b√∫squeda");

    return data.items.map((item) => ({
      id: item.id.videoId,
      title: item.snippet.title,
      channel: item.snippet.channelTitle,
      thumbnail: item.snippet.thumbnails.medium.url,
    }));
  } catch (err) {
    console.error("‚ùå Error buscando videos:", err);
    throw err;
  }
}

// ============================================================
// ‚ñ∂Ô∏è CARGAR VIDEO EN IFRAME
// ============================================================

function loadVideoInIframe(videoId) {
  const iframe = document.getElementById("yt-iframe");
  const container = document.getElementById("yt-iframe-container");

  if (!iframe || !container) return;

  iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&rel=0`;

  container.classList.remove("hidden");
}

// ============================================================
// üéß RENDERIZAR PLAYLIST SIMPLE
// ============================================================

function renderYouTubePlaylist(videos) {
  const playlist = document.getElementById("yt-playlist");
  playlist.innerHTML = videos
    .map(
      (v, i) => `
    <div class="playlist-item" data-id="${v.id}">
      <img src="${v.thumbnail}" class="playlist-thumbnail">
      <div class="playlist-info">
        <p class="playlist-title">${v.title}</p>
        <p class="playlist-channel">${v.channel}</p>
      </div>
    </div>
  `
    )
    .join("");

  // Eventos de click para reproducir
  playlist.querySelectorAll(".playlist-item").forEach((el) => {
    el.addEventListener("click", () => {
      const videoId = el.dataset.id;
      loadVideoInIframe(videoId);
    });
  });
}

// ============================================================
// üîé B√öSQUEDA
// ============================================================

async function handleYouTubeSearch() {
  const input = document.getElementById("yt-search-input");
  const query = input.value.trim();

  if (!query) return;

  const playlist = document.getElementById("yt-playlist");
  playlist.innerHTML = "<p style='text-align:center;'>Buscando...</p>";

  try {
    const videos = await searchYouTubeVideos(query);
    renderYouTubePlaylist(videos);
  } catch (err) {
    playlist.innerHTML = `<p>Error: ${err.message}</p>`;
  }
}

// ============================================================
// üöÄ INICIALIZACI√ìN
// ============================================================

document.addEventListener("DOMContentLoaded", () => {
  document
    .getElementById("yt-search-btn")
    .addEventListener("click", handleYouTubeSearch);

  document
    .getElementById("yt-search-input")
    .addEventListener("keypress", (e) => {
      if (e.key === "Enter") handleYouTubeSearch();
    });
});

// ============================================================
// üîî NOTIFICACIONES CORREGIDAS
// ============================================================
async function loadNotifications() {
  try {
    console.log('üîî Cargando notificaciones...');
    
    // ‚úÖ CORRECCI√ìN: Usar el endpoint correcto
    const response = await fetch(`${API_URL}/api/notifications/unread`, {
      credentials: 'include'
    });

    if (!response.ok) {
      console.warn('‚ö†Ô∏è No se pudieron cargar notificaciones');
      return;
    }

    const notifications = await response.json();
    console.log('‚úÖ Notificaciones cargadas:', notifications.length);

    // Actualizar badge de notificaciones
    const notifBadge = document.getElementById('notif-badge');
    if (notifBadge && notifications.length > 0) {
      notifBadge.textContent = notifications.length > 99 ? '99+' : notifications.length;
      notifBadge.classList.remove('hidden');
    } else if (notifBadge) {
      notifBadge.classList.add('hidden');
    }

    return notifications;
  } catch (error) {
    console.error('‚ùå Error cargando notificaciones:', error);
    return [];
  }
}

// ‚úÖ NUEVO: Cargar contador de notificaciones
async function loadNotificationCount() {
  try {
    const response = await fetch(`${API_URL}/api/notifications/unread-count`, {
      credentials: 'include'
    });

    if (!response.ok) return;

    const { count } = await response.json();
    
    const badge = document.getElementById('notif-badge');
    if (badge) {
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
  } catch (error) {
    console.error('‚ùå Error cargando contador:', error);
  }
}

// ============================================================
// üìä ESTAD√çSTICAS DE ACTIVIDAD CORREGIDAS
// ============================================================
async function loadActivityStats() {
  try {
    console.log('üìä Cargando estad√≠sticas de actividad...');
    
    // ‚úÖ CORRECCI√ìN: Usar endpoint del dashboard que s√≠ existe
    const response = await fetch(`${API_URL}/api/users/me/dashboard`, {
      credentials: 'include'
    });

    if (!response.ok) {
      console.warn('‚ö†Ô∏è No se pudieron cargar estad√≠sticas');
      return;
    }

    const data = await response.json();
    console.log('‚úÖ Dashboard cargado:', data);

    // Actualizar widget de actividad con datos reales
    const statsWidget = document.querySelector('.stats-widget .stats-grid');
    if (statsWidget && data.stats) {
      statsWidget.innerHTML = `
        <div class="stat-card">
          <div class="stat-icon">üìù</div>
          <div class="stat-data">
            <span class="stat-value">${formatNumber(data.stats.posts || 0)}</span>
            <span class="stat-name">Posts</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚ù§Ô∏è</div>
          <div class="stat-data">
            <span class="stat-value">${formatNumber(data.stats.likesReceived || 0)}</span>
            <span class="stat-name">Likes</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üí¨</div>
          <div class="stat-data">
            <span class="stat-value">${formatNumber(data.stats.commentsReceived || 0)}</span>
            <span class="stat-name">Comentarios</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üíæ</div>
          <div class="stat-data">
            <span class="stat-value">${formatNumber(data.stats.savedPosts || 0)}</span>
            <span class="stat-name">Guardados</span>
          </div>
        </div>
      `;
    }
  } catch (error) {
    console.error('‚ùå Error cargando estad√≠sticas:', error);
  }
}

// ============================================================
// üìù CREAR POST - MODAL FUNCIONAL (Sin duplicados)
// ============================================================
function setupCreatePostModal() {
  const modal = document.getElementById('post-modal');
  const closeBtn = modal?.querySelector('.close-modal');
  const form = modal?.querySelector('#create-post-form');
  const imageInput = modal?.querySelector('#post-images');
  const imagePreview = modal?.querySelector('#image-preview-container');
  const captionInput = modal?.querySelector('#post-caption');
  const visibilitySelect = modal?.querySelector('#post-visibility');

  // ‚úÖ Evitar registrar eventos duplicados
  if (form?.dataset.initialized === "true") return;
  if (!modal || !form) {
    console.warn('‚ö†Ô∏è Modal de crear post no encontrado');
    return;
  }
  form.dataset.initialized = "true";

  // ============================================================
  // üîí Cerrar modal correctamente
  // ============================================================
  const closeModal = () => {
    modal.classList.add('hidden');
    form.reset();
    if (imagePreview) imagePreview.innerHTML = '';
  };

  closeBtn?.addEventListener('click', closeModal);

  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // ============================================================
  // üñºÔ∏è Previsualizaci√≥n de im√°genes
  // ============================================================
  imageInput?.addEventListener('change', (e) => {
    const files = Array.from(e.target.files || []);
    if (!imagePreview) return;
    imagePreview.innerHTML = '';

    files.forEach((file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `
          <img src="${e.target.result}" alt="Preview" />
          <button type="button" class="remove-image" title="Eliminar">√ó</button>
        `;
        div.querySelector('.remove-image')?.addEventListener('click', () => {
          div.remove();
          const dt = new DataTransfer();
          Array.from(imageInput.files).forEach((f) => {
            if (f !== file) dt.items.add(f);
          });
          imageInput.files = dt.files;
        });
        imagePreview.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  });

  // ============================================================
  // üöÄ Enviar publicaci√≥n
  // ============================================================
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // ‚úÖ Evitar env√≠os m√∫ltiples
    if (form.dataset.submitting === "true") return;
    form.dataset.submitting = "true";

    const caption = captionInput?.value.trim();
    const files = imageInput?.files;
    const visibility = visibilitySelect?.value || 'public';

    if (!caption && (!files || files.length === 0)) {
      showToast('Agrega texto o una imagen', 'error');
      form.dataset.submitting = "false";
      return;
    }

    const formData = new FormData();
    if (caption) formData.append('caption', caption);
    formData.append('visibility', visibility);
    if (files) Array.from(files).forEach((file) => formData.append('images', file));

    const submitBtn = form.querySelector('[type="submit"]');
    
    try {
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Publicando...';
      }

      console.log('üì§ Creando publicaci√≥n...');

      const response = await fetch(`${API_URL}/api/posts`, {
        method: 'POST',
        credentials: 'include',
        body: formData,
      });

      if (!response.ok) throw new Error(`Error al crear publicaci√≥n (${response.status})`);

      const result = await response.json();
      console.log('‚úÖ Post creado:', result);

      showToast('Publicaci√≥n creada exitosamente', 'success');

      // ‚úÖ Cerrar modal y limpiar
      closeModal();

      // ============================================================
      // üîÑ SOLUCI√ìN: Solo agregar el nuevo post (sin recargar todo)
      // ============================================================
      const feedContainer = document.getElementById('posts-feed');
      
      if (result.post && feedContainer) {
        // Verificar que no exista ya (por si hay otro listener)
        const existingPost = feedContainer.querySelector(`[data-post-id="${result.post._id}"]`);
        
        if (!existingPost) {
          // Crear HTML del nuevo post
          const postHTML = createPostHTML(result.post);
          
          // Insertarlo al inicio
          feedContainer.insertAdjacentHTML('afterbegin', postHTML);
          
          // Re-aplicar event listeners (si usas delegation, esto no es necesario)
          if (typeof setupPostInteractions === 'function') {
            setupPostInteractions(result.post._id);
          }
          
          console.log('‚úÖ Post agregado al feed');
        } else {
          console.log('‚ÑπÔ∏è Post ya existe en el feed (evitando duplicado)');
        }
      }

      // üîÅ Actualizar estad√≠sticas del usuario
      if (typeof loadActivityStats === 'function') {
        await loadActivityStats();
      }

    } catch (error) {
      console.error('‚ùå Error creando post:', error);
      showToast('Error al crear la publicaci√≥n', 'error');
    } finally {
      // ‚úÖ Liberar bloqueo
      form.dataset.submitting = "false";
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Publicar';
      }
    }
  });
}

// ============================================================
// üé® FUNCI√ìN AUXILIAR: Crear HTML de un post
// ============================================================
function createPostHTML(post) {
  const currentUser = getCurrentUser(); // Funci√≥n que debes tener
  const isOwner = currentUser && currentUser._id === post.author._id;
  
  // Formatear fecha
  const date = new Date(post.createdAt);
  const timeAgo = formatTimeAgo(date); // Funci√≥n que debes tener
  
  // Im√°genes
  let imagesHTML = '';
  if (post.images && post.images.length > 0) {
    imagesHTML = `
      <div class="post-images">
        ${post.images.map(img => `
          <img src="${img}" alt="Post image" loading="lazy" />
        `).join('')}
      </div>
    `;
  }
  
  // HTML del post
  return `
    <article class="post" data-post-id="${post._id}">
      <div class="post-header">
        <img src="${post.author.profilePicture || '/default-avatar.png'}" 
             alt="${post.author.username}" 
             class="post-avatar" />
        <div class="post-info">
          <a href="/profile/${post.author.username}" class="post-author">
            @${post.author.username}
          </a>
          <span class="post-time">${timeAgo}</span>
        </div>
        ${isOwner ? `
          <button class="post-menu-btn" data-post-id="${post._id}">‚ãÆ</button>
        ` : ''}
      </div>
      
      ${post.caption ? `<p class="post-caption">${escapeHTML(post.caption)}</p>` : ''}
      
      ${imagesHTML}
      
      <div class="post-actions">
        <button class="action-btn like-btn" data-post-id="${post._id}">
          <span class="icon">‚ù§Ô∏è</span>
          <span class="count">${post.likes?.length || 0}</span>
        </button>
        <button class="action-btn comment-btn" data-post-id="${post._id}">
          <span class="icon">üí¨</span>
          <span class="count">${post.comments?.length || 0}</span>
        </button>
        <button class="action-btn share-btn" data-post-id="${post._id}">
          <span class="icon">üîó</span>
        </button>
      </div>
    </article>
  `;
}

// ============================================================
// üõ°Ô∏è FUNCI√ìN AUXILIAR: Escapar HTML
// ============================================================
function escapeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================================
// ‚è∞ FUNCI√ìN AUXILIAR: Formatear tiempo relativo
// ============================================================
function formatTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  
  const intervals = {
    a√±o: 31536000,
    mes: 2592000,
    semana: 604800,
    d√≠a: 86400,
    hora: 3600,
    minuto: 60
  };
  
  for (const [name, value] of Object.entries(intervals)) {
    const interval = Math.floor(seconds / value);
    if (interval >= 1) {
      return `hace ${interval} ${name}${interval > 1 ? 's' : ''}`;
    }
  }
  
  return 'justo ahora';
}

// ============================================================
// üì∏ SISTEMA DE HISTORIAS ‚Äî VERSI√ìN FUNCIONAL FINAL
// ============================================================

// Para que otras funciones lo usen
window.openStoryUploader = openStoryUploader;
window.closeStoryUploader = closeStoryUploader;

// ============================================================
// üé® ABRIR MODAL SUBIR HISTORIA
// ============================================================
function openStoryUploader() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*,video/*';
  input.click();

  input.onchange = async () => {
    const file = input.files?.[0];
    if (!file) return;

    const caption = prompt('Agrega una descripci√≥n (opcional):') || '';
    
    const formData = new FormData();
    formData.append('media', file);
    if (caption) formData.append('caption', caption);

    try {
      const response = await fetch(`${API_URL}/api/stories`, {
        method: 'POST',
        credentials: 'include',
        body: formData
      });

      if (!response.ok) throw new Error('Error al subir historia');

      alert('Historia publicada exitosamente');
      await loadStories();
      
    } catch (error) {
      console.error('Error subiendo historia:', error);
      alert('Error al publicar historia');
    }
  };
}

// ============================================================
// üö™ CERRAR MODAL
// ============================================================
function closeStoryUploader() {
  const modal = document.getElementById("story-upload-modal");
  if (!modal) return;

  modal.classList.remove("active");

  const form = document.getElementById("story-upload-form");
  const preview = document.getElementById("story-preview");

  if (form) form.reset();
  if (preview) {
    preview.innerHTML = `
      <div class="upload-placeholder">
        <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
        <p>Selecciona una imagen o video</p>
      </div>
    `;
  }
}

// ============================================================
// üîç PREVIEW DE IMAGEN / VIDEO
// ============================================================
function handleFileSelect(e) {
  const file = e.target.files[0];
  const preview = document.getElementById("story-preview");

  if (!file || !preview) return;

  const reader = new FileReader();

  reader.onload = (ev) => {
    if (file.type.startsWith("video/")) {
      preview.innerHTML = `<video src="${ev.target.result}" controls autoplay muted loop></video>`;
    } else {
      preview.innerHTML = `<img src="${ev.target.result}" class="preview-img" />`;
    }
  };

  reader.readAsDataURL(file);
}

// ============================================================
// üì§ SUBIR HISTORIA ‚Äî FUNCIONAL
// ============================================================
async function handleStoryUpload(e) {
  e.preventDefault();

  const fileInput = document.getElementById("story-file-input");
  const captionInput = document.getElementById("story-caption-input");

  const file = fileInput?.files?.[0];
  if (!file) {
    alert("Selecciona una imagen o video");
    return;
  }

  const btnText = document.querySelector(".btn-text");
  const loader = document.querySelector(".btn-loader");
  const submitBtn = document.querySelector(".btn-upload-story");

  btnText.style.display = "none";
  loader.style.display = "inline";
  submitBtn.disabled = true;

  try {
    const form = new FormData();
    form.append("media", file);
    form.append("caption", captionInput.value || "");

    const res = await fetch(`${API_URL}/api/stories`, {
      method: "POST",
      credentials: "include",
      body: form
    });

    if (!res.ok) throw new Error("Error al subir historia");

    closeStoryUploader();
    await loadStories();

  } catch (err) {
    alert("No se pudo subir la historia");
    console.error(err);
  }

  btnText.style.display = "inline";
  loader.style.display = "none";
  submitBtn.disabled = false;
}

// ============================================================
// üì∏ CARGAR HISTORIAS AGRUPADAS
// ============================================================
async function loadStories() {
  const container = document.querySelector(".stories-section");
  if (!container) return;

  try {
    const res = await fetch(`${API_URL}/api/stories`, { credentials: "include" });
    const stories = await res.json();

    const grouped = {};

    stories.forEach(s => {
      const id = s.author._id;
      if (!grouped[id]) grouped[id] = { user: s.author, stories: [] };
      grouped[id].stories.push(s);
    });

    // üëá CAMBIO AQU√ç: usar foto por defecto si no hay currentUser
    const userAvatar = currentUser?.profilePic || 'https://ui-avatars.com/api/?name=Tu+Historia';

    container.innerHTML = `
      <h2 class="section-title">Historias</h2>

      <div class="stories-list">
        <div class="story-item add-story-item">
          <div class="story-avatar-wrapper add-story">
            <img src="${userAvatar}" class="story-avatar"/>
            <div class="add-story-icon">+</div>
          </div>
          <span class="story-username">Tu historia</span>
        </div>

        ${Object.values(grouped)
          .map(g => `
            <div class="story-item" data-user-id="${g.user._id}">
              <div class="story-avatar-wrapper">
                <img src="${g.user.profilePic}" class="story-avatar"/>
              </div>
              <span class="story-username">${g.user.username}</span>
            </div>
          `).join("")}
      </div>
    `;

    container.querySelector(".add-story-item").addEventListener("click", openStoryUploader);

    container.querySelectorAll("[data-user-id]").forEach(el => {
      el.addEventListener("click", () => {
        const group = grouped[el.dataset.userId];
        if (group) openStoryCarousel(group.stories, 0);
      });
    });
  } catch (err) {
    console.error("Error cargando historias:", err);
  }
}

// ============================================================
// üé¨ VISOR DE HISTORIAS CON NAVEGACI√ìN
// ============================================================
function openStoryCarousel(stories, startIndex = 0) {
  let currentIndex = startIndex;

  const modal = document.createElement("div");
  modal.className = "story-viewer-modal";

  function renderStory() {
    const story = stories[currentIndex];

    modal.innerHTML = `
      <div class="story-viewer-content">

        <div class="story-header">
          <div class="story-author-info">
            <img src="${story.author.profilePic}" class="story-author-avatar"/>
            <div>
              <h4>${story.author.username}</h4>
              <span>${formatTime(story.createdAt)}</span>
            </div>
          </div>
          <button class="close-story-btn">√ó</button>
        </div>

        <div class="story-media-container">
          ${
            story.mediaUrl.endsWith(".mp4") || story.mediaUrl.endsWith(".mov")
              ? `<video src="${story.mediaUrl}" autoplay loop muted controls></video>`
              : `<img src="${story.mediaUrl}" />`
          }
          ${story.caption ? `<p class="story-caption">${story.caption}</p>` : ""}
        </div>

        <div class="story-progress-bars">
          ${stories.map((_, i) => `
            <div class="story-progress-bar ${i < currentIndex ? "complete" : i === currentIndex ? "active" : ""}">
              <div class="story-progress-fill"></div>
            </div>
          `).join("")}
        </div>

        ${currentIndex > 0 ? `<button class="story-nav-btn prev">‚Äπ</button>` : ""}
        ${currentIndex < stories.length - 1 ? `<button class="story-nav-btn next">‚Ä∫</button>` : ""}
      </div>
    `;

    // Registrar vista de la historia actual
    registerStoryView(story._id);
  }

  function handleNavigation(e) {
    if (e.target.classList.contains("close-story-btn") || e.target === modal) {
      modal.remove();
    } else if (e.target.classList.contains("next") && currentIndex < stories.length - 1) {
      currentIndex++;
      renderStory();
    } else if (e.target.classList.contains("prev") && currentIndex > 0) {
      currentIndex--;
      renderStory();
    }
  }

  renderStory();
  document.body.appendChild(modal);
  
  modal.addEventListener("click", handleNavigation);
}

// ============================================================
// üëÅ REGISTRAR VISTA DE HISTORIA
// ============================================================
async function registerStoryView(id) {
  try {
    await fetch(`${API_URL}/api/stories/${id}/view`, {
      method: "POST",
      credentials: "include",
    });
  } catch (err) {
    console.warn("Error registrando vista:", err);
  }
}

// ============================================================
// üçΩÔ∏è TENDENCIAS (RECETAS) ‚Äì VERSI√ìN MODULAR, ESTABLE Y SIN ERRORES
// ============================================================

const RECIPES_API_URL = "https://api.spoonacular.com/recipes";
const RECIPES_API_KEY = "0cb308270e0c4ee584f7c0c82e415d35";

// ------------------------------------------
// üî• Cargar recetas recomendadas
// ------------------------------------------
async function loadRecipeTrends() {
  const container = document.getElementById("trending-list");
  if (!container) {
    console.warn("‚ö†Ô∏è trending-list no existe a√∫n, esperando DOM...");
    return null; 
  }

  try {
    const response = await fetch(
      `${RECIPES_API_URL}/random?number=5&apiKey=${RECIPES_API_KEY}`
    );

    if (!response.ok) throw new Error("Error al obtener recetas");

    const data = await response.json();
    const recipes = data.recipes || [];

    // Guardamos recetas dentro del DOM para acceso r√°pido
    container._recipes = recipes;

    container.innerHTML = recipes
      .map(
        (recipe, i) => `
        <button class="trending-item" data-index="${i}">
          <span class="trend-rank">#${i + 1}</span>
          <div class="trend-info">
            <h4 class="trend-topic">${recipe.title}</h4>
            <p class="trend-count">${recipe.readyInMinutes ?? "?"} min</p>
          </div>
        </button>
      `
      )
      .join("");

    // Eventos para abrir modal
    container.querySelectorAll(".trending-item").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idx = btn.dataset.index;
        openRecipeModal(container._recipes[idx]);
      });
    });

  } catch (err) {
    console.error("‚ùå Error cargando recetas:", err);
    container.innerHTML = `<p class="no-trends">No se pudieron cargar las recetas</p>`;
  }
}

// ------------------------------------------
// üç≥ Modal para mostrar ingredientes y pasos
// ------------------------------------------
function openRecipeModal(recipe) {
  const modal = document.createElement("div");
  modal.className = "meal-modal";

  const ingredients = (recipe.extendedIngredients || []).map((ing) => {
    return (
      ing.originalString ||
      `${ing.measures?.metric?.amount ?? ""} ${
        ing.measures?.metric?.unitShort ?? ""
      } ${ing.name}`
    );
  });

  modal.innerHTML = `
    <div class="meal-modal-content">
      <button class="close-meal-btn">√ó</button>
      <h3 class="meal-title">${recipe.title}</h3>
      <img src="${recipe.image}" class="meal-image" />

      <h4>Ingredientes</h4>
      <ul class="meal-ingredients">
        ${ingredients.map((i) => `<li>${i}</li>`).join("")}
      </ul>

      ${
        recipe.instructions
          ? `<h4>Preparaci√≥n</h4><p>${recipe.instructions}</p>`
          : ""
      }

      ${
        recipe.sourceUrl
          ? `<a class="recipe-source" href="${recipe.sourceUrl}" target="_blank">Ver receta completa</a>`
          : ""
      }
    </div>
  `;

  document.body.appendChild(modal);

  modal.addEventListener("click", (e) => {
    if (e.target === modal || e.target.classList.contains("close-meal-btn")) {
      modal.remove();
    }
  });
}

// ------------------------------------------
// üåü Funci√≥n principal (controla la carga)
// ------------------------------------------
async function initTrendingRecipes() {
  console.log("üçΩÔ∏è Iniciando m√≥dulo de recetas...");

  const trendingContainer = document.getElementById("trending-list");

  if (!trendingContainer) {
    console.warn("‚è≥ trending-list no encontrado, reintentando...");

    // üïí Reintento autom√°tico si la UI a√∫n no carg√≥
    setTimeout(initTrendingRecipes, 300);
    return;
  }

  await loadRecipeTrends();
}

// ============================================================
// üîÑ ACTUALIZACI√ìN AUTOM√ÅTICA DE DATOS
// ============================================================
function setupAutoRefresh() {
  // Actualizar notificaciones cada 30 segundos
  setInterval(() => {
    loadNotificationCount();
  }, 30000);

  // Actualizar historias cada 5 minutos
  setInterval(() => {
    loadStories();
  }, 300000);

  // Actualizar tendencias cada 10 minutos
  setInterval(() => {
    loadTrendingTopics();
  }, 600000);
}

// ============================================================
// üìç GEOLOCALIZACI√ìN Y USUARIOS CERCANOS
// ============================================================
async function updateUserLocation() {
  if (!navigator.geolocation) {
    showToast('Geolocalizaci√≥n no disponible', 'error');
    return;
  }

  try {
    const position = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject);
    });

    const { latitude: lat, longitude: lng } = position.coords;

    // Obtener informaci√≥n de ubicaci√≥n (pa√≠s, ciudad)
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    const data = await response.json();
    
    const country = data.address?.country || '';
    const city = data.address?.city || data.address?.town || data.address?.village || '';

    // Actualizar en el backend
    await fetch(`${API_URL}/api/users/location`, {
      method: 'PUT',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ lat, lng, country, city })
    });

    showToast('Ubicaci√≥n actualizada', 'success');
    console.log('üìç Ubicaci√≥n actualizada:', { lat, lng, country, city });
    
  } catch (error) {
    console.error('‚ùå Error actualizando ubicaci√≥n:', error);
    showToast('Error al actualizar ubicaci√≥n', 'error');
  }
}

async function loadNearbyUsers() {
  if (!navigator.geolocation) return;

  try {
    const position = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject);
    });

    const { latitude: lat, longitude: lng } = position.coords;

    const response = await fetch(`${API_URL}/api/users/nearby?lat=${lat}&lng=${lng}`, {
      credentials: 'include'
    });

    if (!response.ok) throw new Error('Error cargando usuarios cercanos');

    const nearbyUsers = await response.json();
    console.log(`üìç ${nearbyUsers.length} usuarios cercanos encontrados`);

    // Mostrar en la UI (opcional - puedes crear un widget para esto)
    if (nearbyUsers.length > 0) {
      showToast(`${nearbyUsers.length} usuarios cerca de ti`, 'info');
    }

    return nearbyUsers;
  } catch (error) {
    console.error('‚ùå Error cargando usuarios cercanos:', error);
    return [];
  }
}

// ============================================================
// üéØ INICIALIZACI√ìN COMPLETA Y CORREGIDA
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Inicializando Social Feed...');

  try {
    // 1. Cargar usuario (cr√≠tico - sin esto nada funciona)
    await loadUserData();
    
    if (!currentUser) {
      console.error('‚ùå No se pudo cargar el usuario');
      window.location.href = '/login';
      return;
    }

    // 2. Cargar contenido principal
    await Promise.all([
      loadFeed(1, 'all'),
      loadStories(),
      loadNotificationCount(),
      initTrendingRecipes(),
      loadUserSuggestions()  
    ]);

    // 3. Cargar datos secundarios (no bloquean la UI)
    setTimeout(() => {
      loadActivityStats();
      updateUserLocation();
    }, 1000);

    // 4. Setup de funcionalidades
    setupCreatePostModal();
    setupAutoRefresh();
    setupInfiniteScroll();
    setupFilterTabs();
    setupQuickActions();
    setupRefreshButton();

    console.log('‚úÖ Inicializaci√≥n completa');

  } catch (error) {
    console.error('‚ùå Error en inicializaci√≥n:', error);
    showToast('Error al cargar la aplicaci√≥n', 'error');
  }
});

// ============================================================
// üîÑ SCROLL INFINITO
// ============================================================
function setupInfiniteScroll() {
  const trigger = document.getElementById('scroll-trigger');
  if (!trigger) return;

  const observer = new IntersectionObserver(
    (entries) => {
      if (entries[0].isIntersecting && !isLoading && hasMore) {
        currentPage++;
        loadFeed(currentPage, currentFilter);
      }
    },
    { threshold: 0.5 }
  );

  observer.observe(trigger);
}

// ============================================================
// üé® TABS DE FILTRO
// ============================================================
function setupFilterTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      // Remover active de todos
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      
      // Activar el clickeado
      tab.classList.add('active');
      
      // Aplicar filtro
      const filter = tab.dataset.filter;
      if (filter !== currentFilter) {
        currentFilter = filter;
        currentPage = 1;
        hasMore = true;
        
        // Limpiar feed y recargar
        const feedContainer = document.getElementById('posts-feed');
        if (feedContainer) feedContainer.innerHTML = '';
        
        loadFeed(1, currentFilter);
      }
    });
  });
}

// ============================================================
// ‚ö° ACCIONES R√ÅPIDAS - CORREGIDO
// ============================================================
function setupQuickActions() {
  // Botones de crear post
  const createPostBtn = document.getElementById('create-post-btn');
  const quickPostInput = document.getElementById('quick-post-input');
  const quickActionBtns = document.querySelectorAll('.quick-action-btn');
  const modal = document.getElementById('post-modal');

  [createPostBtn, quickPostInput, ...quickActionBtns].forEach(btn => {
    btn?.addEventListener('click', () => {
      modal?.classList.remove('hidden');
    });
  });

  // Cerrar toast
  document.querySelector('.toast-close')?.addEventListener('click', () => {
    document.getElementById('toast')?.classList.add('hidden');
  });
} // ‚úÖ LLAVE FALTANTE AGREGADA

// ============================================================
// üõ†Ô∏è UTILIDAD: Obtener usuario actual
// ============================================================
function getCurrentUser() {
  return currentUser;
}

// ============================================================
// üë• SUGERENCIAS DE USUARIOS (SIN DUPLICAR addEventListener)
// ============================================================
async function loadUserSuggestions() {
  const container = document.getElementById("suggested-users");
  if (!container) return;

  container.innerHTML = `<p class="loading-text">Cargando...</p>`;

  try {
    const res = await fetch(`${API_URL}/api/users/suggestions`, {
      method: "GET",
      credentials: "include",
    });

    if (!res.ok) throw new Error("Error al obtener sugerencias");

    const users = await res.json();

    if (!users || users.length === 0) {
      container.innerHTML = `<p class="no-suggestions">No hay sugerencias por ahora</p>`;
      return;
    }

    container.innerHTML = users
      .map((u) => {
        const avatar =
          u.profilePic ||
          `https://ui-avatars.com/api/?name=${encodeURIComponent(u.username)}&size=40&background=random`;

        return `
        <div class="suggestion-card" data-user-id="${u._id}">
          <img src="${avatar}" alt="${u.username}" class="suggestion-avatar" />

          <div class="suggestion-info">
            <h4 class="suggestion-name">${u.username}</h4>
            <p class="suggestion-status">${u.bio?.substring(0, 40) || "Usuario de FoodEmotions"}</p>
          </div>

          <button class="follow-btn" data-id="${u._id}">
            Seguir
          </button>
        </div>
      `;
      })
      .join("");

    // ‚ûï Evento para seguir usuarios
    container.querySelectorAll(".follow-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const userId = btn.dataset.id;
        await followUser(userId);
      });
    });
  } catch (err) {
    console.error("‚ùå Error sugerencias:", err);
    container.innerHTML = `<p class="no-suggestions">Error al cargar sugerencias</p>`;
  }
}

// ============================================================
// ü§ù FUNCI√ìN PARA SEGUIR UN USUARIO
// ============================================================
async function followUser(userId) {
  try {
    const res = await fetch(`${API_URL}/api/users/${userId}/follow`, {
      method: "POST",
      credentials: "include",
    });

    if (!res.ok) throw new Error("Error al seguir usuario");

    // Encontrar y animar la tarjeta antes de removerla
    const card = document.querySelector(`[data-user-id="${userId}"]`);
    if (card) {
      // Animaci√≥n de salida
      card.style.transition = 'all 0.3s ease';
      card.style.opacity = '0';
      card.style.transform = 'translateX(-20px)';
      
      // Esperar a que termine la animaci√≥n
      await new Promise(resolve => setTimeout(resolve, 300));
      card.remove();
    }

    showToast("Ahora sigues a este usuario", "success");

    // Cargar un nuevo usuario para reemplazar el que se fue
    await loadOneNewSuggestion();

  } catch (err) {
    console.error("‚ùå Error siguiendo usuario:", err);
    showToast("No se pudo seguir al usuario", "error");
  }
}

// ============================================================
// üÜï CARGAR UN NUEVO USUARIO SUGERIDO
// ============================================================
async function loadOneNewSuggestion() {
  try {
    const res = await fetch(`${API_URL}/api/users/suggestions?limit=1`, {
      method: "GET",
      credentials: "include",
    });

    if (!res.ok) return;

    const users = await res.json();
    if (!users || users.length === 0) return;

    const container = document.getElementById("suggested-users");
    if (!container) return;

    const u = users[0];
    const avatar =
      u.profilePic ||
      `https://ui-avatars.com/api/?name=${encodeURIComponent(u.username)}&size=40&background=random`;

    const newCard = document.createElement('div');
    newCard.className = 'suggestion-card';
    newCard.setAttribute('data-user-id', u._id);
    newCard.style.opacity = '0';
    newCard.style.transform = 'translateX(20px)';
    
    newCard.innerHTML = `
      <img src="${avatar}" alt="${u.username}" class="suggestion-avatar" />
      <div class="suggestion-info">
        <h4 class="suggestion-name">${u.username}</h4>
        <p class="suggestion-status">${u.bio?.substring(0, 40) || "Usuario de FoodEmotions"}</p>
      </div>
      <button class="follow-btn" data-id="${u._id}">
        Seguir
      </button>
    `;

    container.appendChild(newCard);

    // Animar entrada
    setTimeout(() => {
      newCard.style.transition = 'all 0.3s ease';
      newCard.style.opacity = '1';
      newCard.style.transform = 'translateX(0)';
    }, 50);

    // Agregar evento al bot√≥n
    newCard.querySelector('.follow-btn').addEventListener('click', async () => {
      await followUser(u._id);
    });

  } catch (err) {
    console.error("‚ùå Error cargando nueva sugerencia:", err);
  }
}

// ============================================================
// üîÑ REFRESH BUTTON - SOLO UNA VEZ
// ============================================================
function setupRefreshButton() {
  document
    .getElementById("refresh-suggestions")
    ?.addEventListener("click", loadUserSuggestions);
}

// ============================================================
// üìù FUNCI√ìN FALTANTE: CARGAR FEED
// ============================================================
async function loadFeed(page = 1, filter = 'all') {
  if (isLoading || (!hasMore && page > 1)) return;
  
  isLoading = true;
  const loading = document.querySelector('.loading-state');
  if (loading) loading.style.display = 'flex';

  try {
    console.log(`üìù Cargando feed (p√°gina ${page}, filtro: ${filter})...`);
    
    const response = await fetch(
      `${API_URL}/api/posts/feed?page=${page}&limit=10&filter=${filter}`,
      {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      }
    );

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    const posts = data.posts || [];
    
    console.log(`‚úÖ ${posts.length} posts cargados`);

    const feedContainer = document.getElementById('posts-feed');
    
    if (posts.length === 0 && page === 1) {
      hasMore = false;
      feedContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </div>
          <h3>No hay publicaciones</h3>
          <p>Sigue a m√°s personas para ver contenido aqu√≠</p>
          <button class="btn-primary" onclick="window.location.href='/Explore'">Explorar usuarios</button>
        </div>
      `;
      return;
    }

    if (page === 1) feedContainer.innerHTML = '';

    posts.forEach(post => {
      feedContainer.appendChild(createPostCard(post));
    });

    hasMore = data.hasMore !== false && posts.length === 10;

  } catch (error) {
    console.error('‚ùå Error cargando feed:', error);
    showToast('Error al cargar publicaciones', 'error');
  } finally {
    isLoading = false;
    if (loading) loading.style.display = 'none';
  }
}

// ============================================================
// üé® FUNCI√ìN MEJORADA: CREAR CARD DE POST
// ============================================================
function createPostCard(post) {
  const card = document.createElement('article');
  card.className = 'post-card';
  card.dataset.postId = post._id;

  const isLiked = post.likes?.some(id => id.toString() === currentUser?._id?.toString());
  const isSaved = currentUser?.savedPosts?.some(id => id.toString() === post._id.toString());

  // ‚úÖ FIX CR√çTICO: Asegurar que post.author._id existe
  const authorId = post.author?._id || post.author;
  const authorUsername = post.author?.username || 'Usuario';
  const authorProfilePic = post.author?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(authorUsername)}`;

  card.innerHTML = `
    <div class="post-card-header">
      <div class="author-info">
        <img src="${authorProfilePic}" 
             alt="${authorUsername}" 
             class="author-avatar" />
        <div class="author-details">
          <a href="/Profile?user=${authorId}" class="author-name">${authorUsername}</a>
          <span class="post-timestamp">${formatTime(post.createdAt)}</span>
        </div>
      </div>
      <button class="post-menu-btn" data-post-id="${post._id}">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <circle cx="12" cy="5" r="2"/>
          <circle cx="12" cy="12" r="2"/>
          <circle cx="12" cy="19" r="2"/>
        </svg>
      </button>
    </div>

    ${post.caption ? `
      <div class="post-content">
        <p class="post-text">${linkifyHashtags(escapeHtml(post.caption))}</p>
      </div>
    ` : ''}

    ${post.images?.length > 0 ? `
      <div class="post-media">
        <img src="${post.images[0]}" alt="Post image" class="post-image" loading="lazy" />
        ${post.images.length > 1 ? `
          <div class="media-counter">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
            </svg>
            1/${post.images.length}
          </div>
        ` : ''}
      </div>
    ` : ''}

    <div class="post-engagement">
      <div class="engagement-stats">
        <button class="stat-btn likes-btn" data-post-id="${post._id}">
          <span class="stat-value">${formatNumber(post.likes?.length || 0)}</span>
          <span class="stat-label">likes</span>
        </button>
        <button class="stat-btn comments-btn" data-post-id="${post._id}">
          <span class="stat-value">${formatNumber(post.comments?.length || 0)}</span>
          <span class="stat-label">comentarios</span>
        </button>
        <span class="stat-views">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          ${formatNumber(post.views || 0)}
        </span>
      </div>

      <div class="post-actions">
        <button class="action-button ${isLiked ? 'active' : ''}" data-action="like" data-post-id="${post._id}">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
          </svg>
          <span>${isLiked ? 'Te gusta' : 'Me gusta'}</span>
        </button>
        
        <button class="action-button" data-action="comment" data-post-id="${post._id}">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
          </svg>
          <span>Comentar</span>
        </button>
        
        <button class="action-button" data-action="share" data-post-id="${post._id}">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"/>
            <circle cx="6" cy="12" r="3"/>
            <circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
          <span>Compartir</span>
        </button>
        
        <button class="action-button ${isSaved ? 'active' : ''}" data-action="save" data-post-id="${post._id}">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="${isSaved ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="comments-section collapsed" id="comments-${post._id}">
      <div class="comments-list"></div>
      <div class="comment-input-wrapper">
        <img src="${currentUser?.profilePic || `https://ui-avatars.com/api/?name=User`}" alt="You" class="comment-user-avatar" />
        <input type="text" 
               class="comment-input" 
               placeholder="Escribe un comentario..." 
               data-post-id="${post._id}" />
        <button class="send-comment-btn" data-post-id="${post._id}">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
    </div>
  `;

  setupPostInteractions(card, post);
  return card;
}

// ============================================================
// üéØ SETUP DE INTERACCIONES DE POST
// ============================================================
function setupPostInteractions(card, post) {
  // Like
  const likeBtn = card.querySelector('[data-action="like"]');
  likeBtn?.addEventListener('click', () => handleLike(post._id));

  // Comment
  const commentBtn = card.querySelector('[data-action="comment"]');
  commentBtn?.addEventListener('click', () => toggleComments(post._id));

  // Share
  const shareBtn = card.querySelector('[data-action="share"]');
  shareBtn?.addEventListener('click', () => handleShare(post._id));

  // Save
  const saveBtn = card.querySelector('[data-action="save"]');
  saveBtn?.addEventListener('click', () => handleSave(post._id, saveBtn));

  // Send comment
  const sendBtn = card.querySelector('.send-comment-btn');
  const commentInput = card.querySelector('.comment-input');
  
  sendBtn?.addEventListener('click', () => sendComment(post._id));
  commentInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && e.target.value.trim()) {
      sendComment(post._id);
    }
  });

  // Menu
  const menuBtn = card.querySelector('.post-menu-btn');
  menuBtn?.addEventListener('click', (e) => showPostMenu(e, post));
}

// ============================================================
// ‚ù§Ô∏è MANEJAR LIKE
// ============================================================
async function handleLike(postId) {
  try {
    console.log('‚ù§Ô∏è Like/unlike post:', postId);
    
    const response = await fetch(`${API_URL}/api/posts/${postId}/like`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) throw new Error('Error al dar like');

    const result = await response.json();
    console.log('‚úÖ Like response:', result);

    // Actualizar UI
    const likeBtn = document.querySelector(`[data-action="like"][data-post-id="${postId}"]`);
    const likesCountEl = document.querySelector(`.likes-btn[data-post-id="${postId}"] .stat-value`);

    if (likeBtn) {
      const svg = likeBtn.querySelector('svg');
      const span = likeBtn.querySelector('span');
      
      if (result.liked) {
        likeBtn.classList.add('active');
        svg.setAttribute('fill', 'currentColor');
        span.textContent = 'Te gusta';
      } else {
        likeBtn.classList.remove('active');
        svg.setAttribute('fill', 'none');
        span.textContent = 'Me gusta';
      }
    }

    if (likesCountEl) {
      likesCountEl.textContent = formatNumber(result.likesCount || 0);
    }

  } catch (error) {
    console.error('‚ùå Error al dar like:', error);
    showToast('Error al dar like', 'error');
  }
}

// ============================================================
// üí¨ TOGGLE COMENTARIOS
// ============================================================
async function toggleComments(postId) {
  const section = document.getElementById(`comments-${postId}`);
  const commentsList = section?.querySelector('.comments-list');
  
  if (!section) return;

  // Si ya est√° abierto, cerrar
  if (!section.classList.contains('collapsed')) {
    section.classList.add('collapsed');
    return;
  }

  section.classList.remove('collapsed');

  // Si ya tiene comentarios cargados, no recargar
  if (commentsList && commentsList.innerHTML) return;

  try {
    console.log('üí¨ Cargando comentarios de post:', postId);
    
    const response = await fetch(`${API_URL}/api/posts/${postId}/comments`, {
      credentials: 'include'
    });

    if (!response.ok) throw new Error('Error cargando comentarios');

    const comments = await response.json();
    console.log(`‚úÖ ${comments.length} comentarios cargados`);

    if (commentsList) {
      if (comments.length === 0) {
        commentsList.innerHTML = '<p class="no-comments">S√© el primero en comentar</p>';
      } else {
        commentsList.innerHTML = comments.map(c => `
          <div class="comment-item">
            <img src="${c.user?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.user?.username || 'User')}`}" 
                 alt="${c.user?.username || 'Usuario'}" 
                 class="comment-avatar" />
            <div class="comment-body">
              <div class="comment-header">
                <a href="/Profile?user=${c.user?._id}" class="comment-author">${c.user?.username || 'Usuario'}</a>
                <span class="comment-time">${formatTime(c.createdAt)}</span>
              </div>
              <p class="comment-text">${escapeHtml(c.text)}</p>
            </div>
          </div>
        `).join('');
      }
    }
  } catch (error) {
    console.error('‚ùå Error cargando comentarios:', error);
    showToast('Error al cargar comentarios', 'error');
  }
}

// ============================================================
// üì§ ENVIAR COMENTARIO
// ============================================================
async function sendComment(postId) {
  const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
  const text = input?.value.trim();
  
  if (!text) return;

  try {
    console.log('üì§ Enviando comentario...');
    
    const response = await fetch(`${API_URL}/api/posts/${postId}/comments`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ text })
    });

    if (!response.ok) throw new Error('Error al comentar');

    const result = await response.json();
    console.log('‚úÖ Comentario publicado:', result);

    input.value = '';
    
    // Actualizar contador
    const commentsBtn = document.querySelector(`.comments-btn[data-post-id="${postId}"] .stat-value`);
    if (commentsBtn) {
      const count = parseInt(commentsBtn.textContent) + 1;
      commentsBtn.textContent = formatNumber(count);
    }

    // Recargar comentarios
    const section = document.getElementById(`comments-${postId}`);
    const commentsList = section?.querySelector('.comments-list');
    if (commentsList) {
      commentsList.innerHTML = '';
      setTimeout(() => toggleComments(postId), 50);
      setTimeout(() => toggleComments(postId), 100);
    }

    showToast('Comentario publicado', 'success');
  } catch (error) {
    console.error('‚ùå Error:', error);
    showToast('Error al comentar', 'error');
  }
}

// ============================================================
// üîó COMPARTIR POST
// ============================================================
async function handleShare(postId) {
  try {
    const url = `${window.location.origin}/post/${postId}`;
    
    if (navigator.share) {
      await navigator.share({
        title: 'Mira esta publicaci√≥n',
        url: url
      });
      showToast('Publicaci√≥n compartida', 'success');
    } else {
      await navigator.clipboard.writeText(url);
      showToast('Enlace copiado al portapapeles', 'success');
    }
  } catch (error) {
    if (error.name !== 'AbortError') {
      console.error('‚ùå Error al compartir:', error);
    }
  }
}

// ============================================================
// üíæ GUARDAR POST
// ============================================================
async function handleSave(postId, button) {
  try {
    console.log('üíæ Guardar/desguardar post:', postId);
    
    const response = await fetch(`${API_URL}/api/posts/${postId}/save`, {
      method: 'POST',
      credentials: 'include'
    });

    if (!response.ok) throw new Error('Error al guardar');

    const result = await response.json();
    console.log('‚úÖ Save response:', result);

    button.classList.toggle('active');
    const svg = button.querySelector('svg');
    const isActive = button.classList.contains('active');
    svg.setAttribute('fill', isActive ? 'currentColor' : 'none');

    showToast(result.saved ? 'Publicaci√≥n guardada' : 'Guardado eliminado', 'success');
  } catch (error) {
    console.error('‚ùå Error al guardar:', error);
    showToast('Error al guardar publicaci√≥n', 'error');
  }
}

// ============================================================
// üìã MEN√ö CONTEXTUAL DE POST
// ============================================================
function showPostMenu(e, post) {
  e.stopPropagation();
  
  // Cerrar otros men√∫s
  document.querySelectorAll('.post-menu').forEach(m => m.remove());
  
  const isOwner = post.author?._id === currentUser?._id;
  
  const menu = document.createElement('div');
  menu.className = 'post-menu';
  menu.innerHTML = `
    <button class="menu-item" data-action="copy-link">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/>
      </svg>
      Copiar enlace
    </button>
    ${!isOwner ? `
      <button class="menu-item" data-action="report">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        Reportar
      </button>
    ` : ''}
    ${isOwner ? `
      <button class="menu-item danger" data-action="delete">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
        Eliminar
      </button>
    ` : ''}
  `;
  
  const menuBtn = e.target.closest('.post-menu-btn');
  menuBtn.parentElement.style.position = 'relative';
  menuBtn.parentElement.appendChild(menu);
  
  // Cerrar al hacer clic fuera
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
  
  // Acciones del men√∫
  menu.addEventListener('click', async (e) => {
    const item = e.target.closest('.menu-item');
    if (!item) return;
    
    const action = item.dataset.action;
    const postCard = menu.closest('.post-card');

    switch (action) {
      case 'copy-link':
        try {
          const url = `${window.location.origin}/post/${post._id}`;
          await navigator.clipboard.writeText(url);
          showToast('Enlace copiado', 'success');
        } catch {
          showToast('Error al copiar enlace', 'error');
        }
        break;
      case 'report':
        showToast('Publicaci√≥n reportada', 'success');
        break;
      case 'delete':
        if (confirm('¬øEst√°s seguro de eliminar esta publicaci√≥n?')) {
          try {
            const response = await fetch(`${API_URL}/api/posts/${post._id}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            if (response.ok) {
              postCard.remove();
              showToast('Publicaci√≥n eliminada', 'success');
              await loadActivityStats(); // Actualizar stats
            }
          } catch {
            showToast('Error al eliminar', 'error');
          }
        }
        break;
    }
    menu.remove();
  });
}

// ============================================================
// üõ†Ô∏è UTILIDADES
// ============================================================
function formatTime(timestamp) {
  const now = new Date();
  const date = new Date(timestamp);
  const diff = now - date;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return 'Ahora';
  if (minutes < 60) return `${minutes}m`;
  if (hours < 24) return `${hours}h`;
  if (days < 7) return `${days}d`;
  return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
}

function formatNumber(num) {
  if (!num) return 0;
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
}

function linkifyHashtags(text) {
  if (!text) return '';
  return text.replace(/#(\w+)/g, '<a href="/Explore?tag=$1" class="hashtag">#$1</a>');
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const icon = toast?.querySelector('.toast-icon');
  const msg = toast?.querySelector('.toast-message');
  
  if (!toast || !icon || !msg) return;
  
  const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ' };
  
  icon.textContent = icons[type] || icons.info;
  msg.textContent = message;
  toast.className = `toast-notification ${type}`;
  toast.classList.remove('hidden');
  
  setTimeout(() => toast.classList.add('hidden'), 4000);
}
</script>

<style>
  :root {
  --primary: #687450;
  --primary-dark: #5a6444;
  --secondary: #425638;
  --accent: #8a9b6f;
  --dark: #2d2d2d;
  --gray: #6b7280;
  --gray-light: #f5f5f3;
  --border: #e5e7e3;
  --success: #687450;
  --error: #d84315;
  --card-bg: #ffffff;
  --shadow-sm: 0 1px 3px rgba(66, 86, 56, 0.1);
  --shadow-md: 0 4px 6px rgba(66, 86, 56, 0.15);
  --shadow-lg: 0 10px 15px rgba(66, 86, 56, 0.2);
  --radius: 12px;
  --radius-sm: 8px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--gray-light);
  color: var(--dark);
  line-height: 1.6;
}

/* ===== MAIN LAYOUT ===== */
.social-layout {
  display: grid;
  grid-template-columns: 280px 1fr 340px;
  gap: 24px;
  max-width: 1400px;
  margin: 90px auto 40px;
  padding: 0 24px;
  top: 0;
}

.social-layout[data-show-nav="false"] {
  margin-top: 40px;
}

/* ===== SIDEBAR LEFT ===== */
:global(.sidebar-left) {
  position: sticky;
  top: 90px;
  height: fit-content;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.social-layout[data-show-nav="false"] .sidebar-left {
  top: 40px;
}

.user-profile-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  text-align: center;
}

.profile-header {
  position: relative;
  display: inline-block;
  margin-bottom: 16px;
}

.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--primary);
}

.profile-badge {
  position: absolute;
  bottom: 2px;
  right: 2px;
  width: 20px;
  height: 20px;
  background: var(--success);
  border: 3px solid var(--card-bg);
  border-radius: 50%;
}

.profile-name {
  font-size: 18px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 4px;
}

.profile-handle {
  font-size: 14px;
  color: var(--gray);
  margin-bottom: 20px;
}

.profile-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

.stat-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.stat-number {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
}

:global(.stat-label) {
  font-size: 12px;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ===== NAVIGATION ===== */
.main-navigation {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 12px;
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.nav-link {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  color: var(--gray);
  text-decoration: none;
  font-weight: 500;
  transition: all 0.2s;
  position: relative;
}

.nav-link:hover {
  background: var(--gray-light);
  color: var(--dark);
}

.nav-link.active {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
}

.nav-link svg {
  flex-shrink: 0;
}

.notification-badge {
  position: absolute;
  right: 12px;
  background: var(--error);
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 20px;
  text-align: center;
}

.notification-badge.hidden {
  display: none;
}

.create-post-btn {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  padding: 14px 20px;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: var(--shadow-md);
  transition: all 0.3s;
}

.create-post-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.create-post-btn:active {
  transform: translateY(0);
}

/* ===== MAIN CONTENT ===== */
.main-content {
  max-width: 680px;
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 12px;
}

:global(.stories-section) {
  margin-bottom: 20px;
  background: var(--card-bg);
  padding: 16px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
}

/* ===== QUICK POST ===== */
.quick-post-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.quick-avatar {
  width: 40px !important;
  height: 40px !important;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--primary);
  flex-shrink: 0;
}

.quick-input {
  flex: 1;
  background: var(--gray-light);
  border: 1px solid var(--border);
  padding: 10px 16px;
  border-radius: 24px;
  font-size: 14px;
  color: var(--gray);
  cursor: pointer;
  text-align: left;
  transition: all 0.2s;
}

.quick-input:hover {
  border-color: var(--primary);
  background: white;
}

.quick-actions {
  display: flex;
  gap: 6px;
}

.quick-action-btn {
  background: none;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--gray);
  transition: all 0.2s;
}

.quick-action-btn:hover {
  background: var(--gray-light);
  color: var(--primary);
}

/* ===== FILTER TABS ===== */
.filter-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  background: var(--card-bg);
  padding: 6px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
}

.tab {
  flex: 1;
  background: none;
  border: none;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  font-weight: 600;
  font-size: 13px;
  color: var(--gray);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.2s;
}

.tab:hover {
  background: var(--gray-light);
  color: var(--dark);
}

.tab.active {
  background: var(--primary);
  color: white;
}

.tab svg {
  width: 16px;
  height: 16px;
}

/* ===== POSTS GRID ===== */
.posts-grid {
  display: flex;
  flex-direction: column;
  gap: 16px;
  scroll-behavior: smooth;
}

:global(.post-card) {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  transition: all 0.3s;
  margin-bottom: 16px;
  animation: fadeInUp 0.4s ease-out;
  position: relative;
  contain: layout style paint;
  will-change: transform;
  scroll-margin-top: 80px;
}

.post-card:hover {
  box-shadow: var(--shadow-md);
}

.post-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
  opacity: 0;
  transition: opacity 0.3s;
}

.post-card:hover::before {
  opacity: 1;
}

.post-card::after {
  content: '';
  display: block;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border), transparent);
  margin-top: 0;
}

.post-card:nth-child(1) { animation-delay: 0s; }
.post-card:nth-child(2) { animation-delay: 0.1s; }
.post-card:nth-child(3) { animation-delay: 0.2s; }
.post-card:nth-child(4) { animation-delay: 0.3s; }
.post-card:nth-child(5) { animation-delay: 0.4s; }

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.post-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--card-bg);
}

:global(.author-info) {
  display: flex;
  align-items: center;
  gap: 10px;
}

:global(.author-avatar) {
  width: 40px !important;
  height: 40px !important;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--border);
  flex-shrink: 0;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

:global(.author-details) {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

:global(.author-name) {
  font-weight: 600;
  font-size: 14px;
  color: #1a1a1a;
  text-decoration: none;
  transition: color 0.2s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

:global.author-name:hover) {
  color: var(--primary);
}

.post-timestamp {
  font-size: 12px;
  color: var(--gray);
}

.post-menu-btn {
  background: none;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--gray);
  transition: all 0.2s;
  flex-shrink: 0;
}

.post-menu-btn:hover {
  background: var(--gray-light);
  color: var(--dark);
}

.post-content {
  padding: 12px 16px;
}

.post-text {
  font-size: 15px;
  line-height: 1.5;
  color: #1a1a1a;
  font-weight: 400;
  word-wrap: break-word;
  margin: 0;
}

.hashtag {
  color: var(--primary);
  font-weight: 600;
  text-decoration: none;
  transition: color 0.2s;
}

.hashtag:hover {
  text-decoration: underline;
  color: var(--primary-dark);
}

.post-media {
  position: relative;
  width: 100%;
  background: #f8f9fa;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  overflow: hidden;
}

.post-image {
  width: 100%;
  height: auto;
  max-height: 600px;
  display: block;
  object-fit: contain;
  background: #000;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  content-visibility: auto;
  contain-intrinsic-size: 0 400px;
}

.post-media.multiple-images .post-image {
  aspect-ratio: 1 / 1;
  object-fit: cover;
}

.post-media[data-orientation="portrait"] .post-image {
  max-height: 700px;
  width: 100%;
  object-fit: contain;
}

.post-media[data-orientation="landscape"] .post-image {
  max-height: 500px;
  width: 100%;
  object-fit: contain;
}

.post-media[data-orientation="square"] .post-image {
  max-height: 600px;
  width: 100%;
  object-fit: contain;
}

.media-counter {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(0, 0, 0, 0.75);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
  backdrop-filter: blur(10px);
}

.post-engagement {
  padding: 12px 16px;
}

.engagement-stats {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

.stat-btn {
  background: none;
  border: none;
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  color: var(--dark);
  font-weight: 600;
  transition: color 0.2s;
  padding: 0;
}

.stat-btn:hover {
  color: var(--primary);
}

.stat-btn:active {
  transform: scale(0.95);
}

.stat-value {
  font-size: 14px;
}

.stat-label {
  font-size: 13px;
  color: var(--gray);
}

.stat-views {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
  color: var(--gray);
  margin-left: auto;
}

.post-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}

.action-button {
  background: var(--gray-light);
  border: 1px solid var(--border);
  padding: 8px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray);
  cursor: pointer;
  transition: all 0.2s;
}

.action-button:hover {
  background: white;
  border-color: var(--primary);
  color: var(--primary);
  transform: translateY(-1px);
}

.action-button.active {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}

.action-button:active {
  transform: scale(0.95);
}

.action-button svg {
  flex-shrink: 0;
}

.action-button span {
  display: none;
}

@media (min-width: 640px) {
  .action-button span {
    display: inline;
  }
  
  .action-button {
    padding: 10px 12px;
  }
}

/* ===== COMMENTS ===== */
.comments-section {
  border-top: 1px solid var(--border);
  padding: 16px;
  max-height: 400px;
  overflow-y: auto;
  transition: all 0.3s;
}

.comments-section.collapsed {
  max-height: 0;
  padding: 0;
  overflow: hidden;
}

.comments-section::-webkit-scrollbar {
  width: 4px;
}

.comments-section::-webkit-scrollbar-track {
  background: transparent;
}

.comments-section::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 2px;
}

.comments-list {
  margin-bottom: 16px;
}

_global(.comment-item) {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}

:global(.comment-avatar) {
  width: 32px !important;
  height: 32px !important;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

.comment-body {
  flex: 1;
  background: var(--gray-light);
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  position: relative;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.comment-author {
  font-weight: 600;
  font-size: 13px;
  color: var(--dark);
  text-decoration: none;
}

.comment-author:hover {
  color: var(--primary);
}

.comment-time {
  font-size: 11px;
  color: var(--gray);
}

.comment-text {
  font-size: 14px;
  line-height: 1.4;
  color: var(--dark);
  margin: 0;
}

.comment-like-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--gray);
  transition: color 0.2s;
}

.comment-like-btn:hover {
  color: var(--error);
}

.comment-input-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--gray-light);
  padding: 10px;
  border-radius: var(--radius-sm);
}

:global(.comment-user-avatar) {
  width: 28px !important;
  height: 28px !important;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

.comment-input {
  flex: 1;
  background: white;
  border: 1px solid var(--border);
  padding: 8px 12px;
  border-radius: 20px;
  font-size: 13px;
  outline: none;
  transition: all 0.2s;
}

.comment-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(102, 123, 198, 0.1);
}

.send-comment-btn {
  background: var(--primary);
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  transition: all 0.2s;
  flex-shrink: 0;
}

.send-comment-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

.no-comments {
  text-align: center;
  padding: 20px;
  color: var(--gray);
  font-size: 14px;
}

/* ===== SIDEBAR RIGHT ===== */
.sidebar-right {
  position: sticky;
  top: 90px;
  height: fit-content;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.social-layout[data-show-nav="false"] .sidebar-right {
  top: 40px;
}

.widget {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow-sm);
}

.widget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.widget-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--dark);
  display: flex;
  align-items: center;
  gap: 8px;
}

.refresh-btn {
  background: none;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--gray);
  transition: all 0.2s;
}

.refresh-btn:hover {
  background: var(--gray-light);
  color: var(--primary);
  transform: rotate(180deg);
}

/* ===== TRENDING ===== */
.trending-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.trending-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: var(--radius-sm);
  transition: all 0.2s;
  cursor: pointer;
  text-decoration: none;
}

.trending-item:hover {
  background: var(--gray-light);
}

.trend-rank {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary);
  min-width: 32px;
}

.trend-info {
  flex: 1;
}

.trend-topic {
  font-size: 15px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 2px;
}

.trend-count {
  font-size: 13px;
  color: var(--gray);
}

.no-trends {
  text-align: center;
  padding: 20px;
  color: var(--gray);
  font-size: 14px;
}

/* ===== STATS WIDGET ===== */
:global(.stats-grid) {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

:global(.stat-card) {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  padding: 16px;
  border-radius: var(--radius-sm);
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
}

.stat-icon {
  font-size: 24px;
}

.stat-data {
  display: flex;
  flex-direction: column;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
}

.stat-name {
  font-size: 12px;
  opacity: 0.9;
}

/* ===== LOADING & EMPTY STATES ===== */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  min-height: 200px;
}

.loader {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 12px;
}

.loading-state p {
  color: var(--gray);
  font-size: 14px;
  margin: 0;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.empty-state {
  text-align: center;
  padding: 60px 30px;
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
}

.empty-icon {
  color: var(--gray);
  margin-bottom: 16px;
  opacity: 0.6;
}

.empty-state h3 {
  font-size: 20px;
  font-weight: 700;
  color: var(--dark);
  margin: 0 0 8px 0;
}

.empty-state p {
  font-size: 14px;
  color: var(--gray);
  margin: 0 0 20px 0;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* ===== TOAST ===== */
.toast-notification {
  position: fixed;
  top: 100px;
  right: 24px;
  background: var(--card-bg);
  padding: 16px 20px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1000;
  min-width: 300px;
  animation: slideIn 0.3s ease;
}

.toast-notification.hidden {
  display: none;
}

.toast-notification.success {
  border-left: 4px solid var(--success);
}

.toast-notification.error {
  border-left: 4px solid var(--error);
}

.toast-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 18px;
}

.toast-notification.success .toast-icon {
  background: var(--success);
  color: white;
}

.toast-notification.error .toast-icon {
  background: var(--error);
  color: white;
}

.toast-content {
  flex: 1;
}

.toast-message {
  font-size: 14px;
  font-weight: 500;
  color: var(--dark);
}

.toast-close {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--gray);
  cursor: pointer;
  line-height: 1;
  transition: color 0.2s;
}

.toast-close:hover {
  color: var(--dark);
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ===== POST MENU CONTEXTUAL ===== */
.post-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-lg);
  min-width: 200px;
  z-index: 100;
  overflow: hidden;
  animation: menuSlideIn 0.2s ease;
}

@keyframes menuSlideIn {
  from {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.menu-item {
  width: 100%;
  background: none;
  border: none;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  font-weight: 500;
  color: var(--dark);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.menu-item:hover {
  background: var(--gray-light);
}

.menu-item.danger {
  color: var(--error);
}

.menu-item.danger:hover {
  background: rgba(239, 68, 68, 0.1);
}

.menu-item svg {
  flex-shrink: 0;
}

/* ===== STORY VIEWER MODAL ===== */
:global(.story-viewer-modal) {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

:global(.story-viewer-content) {
  max-width: 500px;
  width: 100%;
  height: 90vh;
  position: relative;
  display: flex;
  flex-direction: column;
}

:global(.story-header) {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
  z-index: 10;
}

:global(.story-author-info) {
  display: flex;
  align-items: center;
  gap: 12px;
}

:global(.story-author-avatar) {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid white;
  object-fit: cover;
}

:global(.story-author-info h4) {
  color: white;
  font-size: 16px;
  font-weight: 600;
  margin: 0;
}

.story-time {
  color: rgba(255, 255, 255, 0.8);
  font-size: 13px;
}

.close-story-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  color: white;
  font-size: 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  backdrop-filter: blur(10px);
}

.close-story-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

:global(.story-media-container) {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

:global(.story-media) {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: var(--radius);
}

:global(.story-caption) {
  position: absolute;
  bottom: 60px;
  left: 20px;
  right: 20px;
  color: white;
  font-size: 16px;
  text-align: center;
  padding: 12px 16px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: var(--radius-sm);
  backdrop-filter: blur(10px);
}

.story-progress-bar {
  position: absolute;
  top: 10px;
  left: 20px;
  right: 20px;
  height: 3px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 2px;
  overflow: hidden;
}

.story-progress-fill {
  height: 100%;
  background: white;
  border-radius: 2px;
  animation: progressFill 5s linear forwards;
}

@keyframes progressFill {
  from { width: 0%; }
  to { width: 100%; }
}

/* ===== STORIES LIST ===== */
:global(.stories-list) {
  display: flex;
  gap: 16px;
  overflow-x: auto;
  padding: 16px 0;
  scrollbar-width: thin;
}

:global(.stories-list::-webkit-scrollbar) {
  height: 6px;
}

:global(.story-item) {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  min-width: 80px;
}

:global(.story-avatar-wrapper) {
  position: relative;
  padding: 3px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
  transition: transform 0.2s;
}

.story-avatar-wrapper:hover {
  transform: scale(1.05);
}

:global(.story-avatar-wrapper.viewed) {
  background: var(--border);
}

.story-avatar-wrapper.add-story {
  background: var(--gray-light);
  position: relative;
}

:global(.story-avatar) {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--card-bg);
  display: block;
}

:global(.add-story-icon) {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 24px;
  height: 24px;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  border: 3px solid var(--card-bg);
}

.story-username {
  font-size: 12px;
  color: var(--dark);
  text-align: center;
  max-width: 80px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.empty-stories {
  text-align: center;
  padding: 40px 20px;
}

.empty-stories p {
  color: var(--gray);
  margin-bottom: 20px;
  font-size: 15px;
}

.add-story-btn {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  box-shadow: var(--shadow-md);
}

.add-story-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* ===== IMAGE PREVIEW ===== */
.image-preview-item {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 2px solid var(--border);
}

.image-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.remove-image {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  border: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  font-weight: 700;
  line-height: 1;
}

.remove-image:hover {
  background: var(--error);
  transform: scale(1.1);
}

/* ===== SEARCH BAR RESULTS ===== */
.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-top: 8px;
  max-height: 400px;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  z-index: 100;
}

.search-result-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: background 0.2s;
  text-decoration: none;
  color: var(--dark);
}

.search-result-item:hover {
  background: var(--gray-light);
}

:global(.search-result-avatar) {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--primary);
}

.search-result-info {
  flex: 1;
}

.search-result-name {
  font-weight: 600;
  font-size: 15px;
  color: var(--dark);
  margin-bottom: 2px;
}

.search-result-username {
  font-size: 13px;
  color: var(--gray);
}

.search-result-badge {
  background: var(--primary);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

/* ===== LOADING SKELETON ===== */
.skeleton-post {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
}

.skeleton-header {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.skeleton-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--gray-light);
  animation: pulse 1.5s ease-in-out infinite;
}

.skeleton-text {
  flex: 1;
}

.skeleton-line {
  height: 16px;
  background: var(--gray-light);
  border-radius: 4px;
  margin-bottom: 8px;
  animation: pulse 1.5s ease-in-out infinite;
}

.skeleton-line.short {
  width: 60%;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

/* ===== EMOJI PICKER ===== */
.emoji-picker {
  position: absolute;
  bottom: 100%;
  right: 0;
  margin-bottom: 8px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  box-shadow: var(--shadow-lg);
  z-index: 100;
  max-height: 300px;
  overflow-y: auto;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 8px;
}

.emoji-item {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  padding: 8px;
  border-radius: var(--radius-sm);
  transition: all 0.2s;
}

.emoji-item:hover {
  background: var(--gray-light);
  transform: scale(1.2);
}

/* ===== SCROLLBAR STYLING ===== */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--gray-light);
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gray);
}

.posts-grid::-webkit-scrollbar {
  width: 6px;
}

.posts-grid::-webkit-scrollbar-track {
  background: transparent;
}

.posts-grid::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

.posts-grid::-webkit-scrollbar-thumb:hover {
  background: var(--gray);
}

/* ===== ACCESSIBILITY ===== */
.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

.nav-link:focus,
.tab:focus,
.action-button:focus,
.create-post-btn:focus,
.quick-input:focus,
.comment-input:focus {
  outline: 3px solid rgba(102, 123, 198, 0.4);
  outline-offset: 2px;
}

:focus-visible {
  outline: 3px solid var(--primary);
  outline-offset: 2px;
}

:focus:not(:focus-visible) {
  outline: none;
}

.post-card:focus-within {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

/* ===== SELECTION ===== */
::selection {
  background: rgba(102, 123, 198, 0.3);
  color: var(--dark);
}

/* ===== SMOOTH SCROLLING ===== */
html {
  scroll-behavior: smooth;
}

/* ===== TRANSITIONS ===== */
* {
  transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}

button,
a,
input,
textarea {
  transition-duration: 0.15s;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1200px) {
  .social-layout {
    grid-template-columns: 280px 1fr;
  }

  .sidebar-right {
    display: none;
  }
}

@media (max-width: 900px) {
  .social-layout {
    grid-template-columns: 1fr;
    margin-top: 70px;
    padding: 0 16px;
  }

  .social-layout[data-show-nav="false"] {
    margin-top: 20px;
  }

  .sidebar-left {
    display: none;
  }

  .main-content {
    max-width: 100%;
  }

  .filter-tabs {
    overflow-x: auto;
    scrollbar-width: none;
  }

  .filter-tabs::-webkit-scrollbar {
    display: none;
  }

  body {
    padding-bottom: 70px;
  }

  .mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--card-bg);
    border-top: 1px solid var(--border);
    padding: 8px 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 100;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
  }

  .mobile-nav-btn {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: var(--gray);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    transition: color 0.2s;
  }

  .mobile-nav-btn.active {
    color: var(--primary);
  }

  .mobile-nav-btn svg {
    width: 24px;
    height: 24px;
  }
}

@media (max-width: 640px) {
  .social-layout {
    padding: 0;
    gap: 16px;
    margin-top: 60px;
  }

  .social-layout[data-show-nav="false"] {
    margin-top: 0;
  }

  .quick-post-card {
    border-radius: 0;
    margin-bottom: 16px;
  }

  :global(.filter-tabs) {
    border-radius: 0;
    margin-bottom: 16px;
  }

  :global(.posts-grid) {
    gap: 16px;
  }

  :global(.post-card) {
    border-radius: 0;
  }

  :global(.author-avatar) {
    width: 36px !important;
    height: 36px !important;
  }

  .quick-avatar {
    width: 36px !important;
    height: 36px !important;
  }

  .post-card-header {
    padding: 10px 12px;
  }

  .post-content {
    padding: 10px 12px;
  }

  .post-engagement {
    padding: 10px 12px;
  }

  .engagement-stats {
    gap: 12px;
    flex-wrap: wrap;
  }

  .post-actions {
    grid-template-columns: repeat(2, 1fr);
  }

  .action-button {
    padding: 10px 8px;
    font-size: 12px;
  }

  .comments-section {
    padding: 12px;
  }

  .comment-avatar {
    width: 28px !important;
    height: 28px !important;
  }

  .post-image {
    max-height: 400px;
  }

  .toast-notification {
    right: 16px;
    left: 16px;
    min-width: auto;
  }

  :global(.story-viewer-content) {
    height: 100vh;
    max-width: 100%;
  }

  :global(.story-media) {
    border-radius: 0;
  }

  :global(.post-menu) {
    left: 0;
    right: 0;
    width: 100%;
    border-radius: 0;
  }

  :global(.stories-list) {
    padding: 12px 16px;
  }

  :global(.story-avatar) {
    width: 56px;
    height: 56px;
  }

  .story-username {
    font-size: 11px;
  }
}

/* ===== DARK MODE SUPPORT ===== */
@media (prefers-color-scheme: dark) {
  :root {
    --dark: #ffffff;
    --gray: #9ca3af;
    --gray-light: #1f2937;
    --border: #374151;
    --card-bg: #111827;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
  }

  body {
    background: #0f172a;
  }

  .quick-input {
    background: #1f2937;
    color: var(--dark);
  }

  .comment-input {
    background: #1f2937;
    color: var(--dark);
  }

  .post-media {
    background: #0a0a0a;
  }

  .post-image {
    background: #1a1a1a;
  }

  .comment-body {
    background: rgba(255, 255, 255, 0.05);
  }
}

/* ===== HIGH CONTRAST MODE ===== */
@media (prefers-contrast: high) {
  .post-card,
  .widget,
  .user-profile-card,
  .main-navigation {
    border: 2px solid var(--dark);
  }

  .action-button,
  .tab,
  .nav-link {
    border: 1px solid var(--dark);
  }
}

/* ===== REDUCED MOTION ===== */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===== PRINT STYLES ===== */
@media print {
  .sidebar-left,
  .sidebar-right,
  .filter-tabs,
  .quick-post-card,
  .post-actions,
  .comments-section,
  .toast-notification,
  .post-menu,
  .story-viewer-modal,
  .post-menu-btn {
    display: none !important;
  }

  .social-layout {
    grid-template-columns: 1fr;
  }

  .post-card {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  .post-image {
    max-height: none !important;
  }
}

/* ===== PREMIUM POLISH ===== */
.glass-effect {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.neon-glow {
  box-shadow: 0 0 20px rgba(102, 123, 198, 0.3),
              0 0 40px rgba(102, 123, 198, 0.2);
}

.gradient-text {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

:global(.youtube-player-widget) {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
  overflow: hidden;
}

:global(.youtube-player-widget.minimized .player-content) {
  max-height: 0;
  padding: 0;
  opacity: 0;
  margin-top: 0;
}

:global(.player-header) {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

:global(.player-toggle-btn) {
  background: none;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--gray);
  transition: all 0.2s;
}

:global(.player-toggle-btn:hover) {
  background: var(--gray-light);
  color: var(--primary);
}

:global(.youtube-player-widget.minimized .player-toggle-btn svg) {
  transform: rotate(180deg);
}

:global(.player-content) {
  max-height: 800px;
  opacity: 1;
  transition: all 0.3s ease;
  overflow: hidden;
  margin-top: 16px;
}

:global(.player-search) {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

:global(.player-search-input) {
  flex: 1;
  background: var(--gray-light);
  border: 1px solid var(--border);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  color: var(--dark);
  outline: none;
  transition: all 0.2s;
}

:global(.player-search-input:focus) {
  border-color: var(--primary);
  background: white;
  box-shadow: 0 0 0 3px rgba(104, 116, 80, 0.1);
}

:global(.player-search-btn) {
  background: var(--primary);
  border: none;
  width: 42px;
  height: 42px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  transition: all 0.2s;
  flex-shrink: 0;
}

:global(.player-search-btn:hover) {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

:global(.player-search-btn:active) {
  transform: translateY(0);
}

/* Playlist */
:global(.player-playlist) {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 16px;
  border-radius: var(--radius-sm);
  scrollbar-width: thin;
}

:global(.player-playlist::-webkit-scrollbar) {
  width: 6px;
}

:global(.player-playlist::-webkit-scrollbar-track) {
  background: transparent;
}

:global(.player-playlist::-webkit-scrollbar-thumb) {
  background: var(--border);
  border-radius: 3px;
}

:global(.player-empty) {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray);
  font-size: 14px;
  background: var(--gray-light);
  border-radius: var(--radius-sm);
}

:global(.playlist-item) {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  background: transparent;
  margin-bottom: 8px;
}

:global(.playlist-item:hover) {
  background: var(--gray-light);
  transform: translateX(2px);
}

:global(.playlist-item.active) {
  background: rgba(104, 116, 80, 0.1);
  border-left: 3px solid var(--primary);
}

:global(.playlist-thumbnail) {
  width: 60px;
  height: 45px;
  object-fit: cover;
  border-radius: 6px;
  flex-shrink: 0;
}

:global(.playlist-info) {
  flex: 1;
  min-width: 0;
}

:global(.playlist-title) {
  font-size: 13px;
  font-weight: 600;
  color: var(--dark);
  margin: 0 0 4px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

:global(.playlist-channel) {
  font-size: 11px;
  color: var(--gray);
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

:global(.playlist-play-btn) {
  background: var(--primary);
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  transition: all 0.2s;
  flex-shrink: 0;
  opacity: 0;
}

:global(.playlist-item:hover .playlist-play-btn) {
  opacity: 1;
}

:global(.playlist-play-btn:hover) {
  background: var(--primary-dark);
  transform: scale(1.1);
}

/* Video actual */
:global(.player-current) {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  padding: 16px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  transition: all 0.3s;
}

:global(.player-current.hidden) {
  display: none;
}

/* ===== ESTILOS ADICIONALES PARA MODAL DE RECETAS ===== */

:global(.meal-modal) {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

:global(.meal-modal-content) {
  background: var(--card-bg);
  border-radius: var(--radius);
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  padding: 24px;
  position: relative;
  box-shadow: var(--shadow-lg);
}

:global(.close-meal-btn) {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  font-size: 32px;
  color: var(--gray);
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

:global(.close-meal-btn:hover) {
  background: var(--gray-light);
  color: var(--dark);
}

:global(.meal-title) {
  font-size: 24px;
  font-weight: 700;
  color: var(--dark);
  margin: 0 0 20px 0;
  padding-right: 40px;
}

:global(.meal-image) {
  width: 100%;
  height: auto;
  max-height: 300px;
  object-fit: cover;
  border-radius: var(--radius-sm);
  margin-bottom: 20px;
}

:global(.meal-modal-content h4) {
  font-size: 18px;
  font-weight: 700;
  color: var(--dark);
  margin: 20px 0 12px 0;
}

:global(.meal-ingredients) {
  list-style: none;
  padding: 0;
  margin: 0 0 20px 0;
}

:global(.meal-ingredients li) {
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  color: var(--dark);
}

:global(.meal-ingredients li:last-child) {
  border-bottom: none;
}

:global(.meal-modal-content p) {
  font-size: 14px;
  line-height: 1.6;
  color: var(--dark);
  margin: 0 0 16px 0;
}

:global(.meal-modal-content a) {
  display: inline-block;
  background: var(--primary);
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius);
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
  margin-top: 12px;
}

:global(.meal-modal-content a:hover) {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* ===== SIDEBAR RIGHT (faltaba en el CSS) ===== */

.sidebar-right {
  position: sticky;
  top: 90px;
  height: fit-content;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.social-layout[data-show-nav="false"] .sidebar-right {
  top: 40px;
}

:global(.recipe-big-modal) {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
}

:global(.recipe-big-modal-content) {
  background: linear-gradient(to bottom right, #425638, #516243, #687450);
  color: #eef3ea;
  padding: 28px;
  border-radius: 20px;
  max-width: 550px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 30px rgba(0,0,0,0.4);
  animation: modal-pop 0.25s ease;
}

@keyframes modal-pop {
  from { transform: scale(0.9); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

:global(.recipe-big-close) {
  background: rgba(255,255,255,0.15);
  border: none;
  color: white;
  font-size: 26px;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  float: right;
}

:global(.recipe-big-image) {
  width: 100%;
  border-radius: 18px;
  margin: 12px 0 18px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
}

:global(.recipe-big-title) {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 4px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

:global(.recipe-big-info) {
  color: #d6e0d2;
  font-size: 15px;
  margin: 0 0 20px;
}

:global(.recipe-big-subtitle) {
  margin-top: 18px;
  font-size: 20px;
  font-weight: 600;
  color: #f0f5ec;
}

:global(.recipe-big-list li) {
  margin: 4px 0;
  font-size: 14px;
  color: #e9f3e4;
}

:global(.recipe-big-text) {
  margin-top: 10px;
  color: #e7f0dc;
  font-size: 15px;
  line-height: 1.5;
}

:global(.recipe-big-link) {
  display: block;
  margin-top: 20px;
  padding: 10px;
  background: rgba(255,255,255,0.15);
  color: #ecf4e8;
  text-align: center;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 600;
}

:global(.recipe-big-link:hover) {
  background: rgba(255,255,255,0.25);
}

:global(.suggested-users-list) {
  display: flex;
  flex-direction: column;
  gap: 0;
  width: 100%;
}

:global(.suggestion-card) {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: transparent;
  border-bottom: 1px solid var(--border-color, #e8e8e8);
  transition: background .2s;
  width: 100%;
}

:global(.suggestion-card:last-child) {
  border-bottom: none;
}

:global(.suggestion-card:hover) {
  background: var(--gray-light, #f5f5f5);
}

:global(.suggestion-avatar) {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

:global(.suggestion-info) {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}

:global(.suggestion-name) {
  font-weight: 600;
  color: var(--dark, #1a1a1a);
  margin: 0 0 2px 0;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

:global(.suggestion-status) {
  font-size: 12px;
  color: var(--gray, #666);
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

:global(.follow-btn) {
  background: var(--primary, #1da1f2);
  color: white;
  border: none;
  padding: 6px 16px;
  border-radius: 20px;
  cursor: pointer;
  transition: background .2s;
  white-space: nowrap;
  flex-shrink: 0;
  font-size: 13px;
  font-weight: 600;
}

:global(.follow-btn:hover) {
  background: var(--primary-dark, #1a8cd8);
}

:global(.loading-text) {
  text-align: center;
  color: var(--gray, #666);
  padding: 20px;
  margin: 0;
}
</style>