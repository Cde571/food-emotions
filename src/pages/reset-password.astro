---
import Layout from "../layouts/Layout.astro";

const email = Astro.url.searchParams.get("email");
const telefono = Astro.url.searchParams.get("telefono");
const identifier = email || telefono || "tu cuenta";
---

<Layout title="Cambiar contrase√±a">
  <section class="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#425638] via-[#556844] to-[#687450] px-6 py-10">

    <div class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl shadow-black/20 border border-white/20">

      <h1 class="text-3xl font-bold text-white mb-4">Restablecer contrase√±a</h1>
      <p class="text-white/80 mb-6">Ingresa tu nueva contrase√±a para {identifier}.</p>

      <form id="resetForm" class="flex flex-col gap-4">
        <div>
          <input
            type="password"
            name="newPassword"
            id="newPassword"
            placeholder="Nueva contrase√±a"
            minlength="6"
            required
            class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/50 focus:bg-white/30 outline-none"
          />
        </div>

        <div>
          <input
            type="password"
            name="confirmPassword"
            id="confirmPassword"
            placeholder="Confirmar contrase√±a"
            minlength="6"
            required
            class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/50 focus:bg-white/30 outline-none"
          />
        </div>

        <div class="text-white/70 text-xs space-y-1 mt-2 bg-white/5 p-3 rounded-lg">
          <p class="font-semibold mb-1">Requisitos de la contrase√±a:</p>
          <p>‚úì M√≠nimo 6 caracteres</p>
          <p>‚úì Se recomienda incluir letras y n√∫meros</p>
          <p>‚úì Evita usar informaci√≥n personal obvia</p>
        </div>

        <button
          type="submit"
          id="resetBtn"
          class="w-full py-3 rounded-xl bg-[#687450] hover:bg-[#79885C] text-white font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed mt-2"
        >
          Guardar contrase√±a
        </button>

        <a 
          href="/login" 
          class="text-center text-white/70 hover:text-white text-sm transition"
        >
          Cancelar y volver al inicio de sesi√≥n
        </a>
      </form>
    </div>

  </section>

  <script>
    const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';
    
    const email = new URLSearchParams(window.location.search).get("email");
    const telefono = new URLSearchParams(window.location.search).get("telefono");
    
    const resetForm = document.getElementById("resetForm") as HTMLFormElement;
    const newPasswordInput = document.getElementById("newPassword") as HTMLInputElement;
    const confirmPasswordInput = document.getElementById("confirmPassword") as HTMLInputElement;
    const resetBtn = document.getElementById("resetBtn") as HTMLButtonElement;

    // Validar que haya email o tel√©fono
    if (!email && !telefono) {
      alert('‚ùå Sesi√≥n inv√°lida. Por favor, vuelve a solicitar el c√≥digo.');
      window.location.href = '/forgot-password';
    }

    // Indicador visual de fortaleza de contrase√±a (opcional)
    newPasswordInput?.addEventListener('input', () => {
      const password = newPasswordInput.value;
      const hasNumber = /\d/.test(password);
      const hasLetter = /[a-zA-Z]/.test(password);
      const isLongEnough = password.length >= 6;

      if (isLongEnough && hasNumber && hasLetter) {
        newPasswordInput.style.borderColor = '#4ade80'; // Verde
      } else if (isLongEnough) {
        newPasswordInput.style.borderColor = '#fbbf24'; // Amarillo
      } else {
        newPasswordInput.style.borderColor = 'transparent';
      }
    });

    resetForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const newPassword = newPasswordInput.value.trim();
      const confirmPassword = confirmPasswordInput.value.trim();

      // Validaciones
      if (!newPassword || !confirmPassword) {
        alert('‚ùå Por favor, completa todos los campos');
        return;
      }

      if (newPassword.length < 6) {
        alert('‚ùå La contrase√±a debe tener al menos 6 caracteres');
        newPasswordInput.focus();
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('‚ùå Las contrase√±as no coinciden');
        confirmPasswordInput.value = '';
        confirmPasswordInput.focus();
        return;
      }

      console.log('üîê Actualizando contrase√±a...');
      console.log('üìß Email:', email);
      console.log('üì± Tel√©fono:', telefono);

      // Deshabilitar bot√≥n mientras se procesa
      resetBtn.disabled = true;
      resetBtn.textContent = 'Guardando...';

      try {
        const payload: { email?: string; telefono?: string; newPassword: string } = { 
          newPassword 
        };
        
        if (email) {
          payload.email = email;
        } else if (telefono) {
          payload.telefono = telefono;
        }

        const res = await fetch(`${API_URL}/api/auth/reset-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        console.log('üì° Status:', res.status);
        const data = await res.json();
        console.log('üìÑ Response:', data);

        if (res.ok) {
          alert('‚úÖ ' + data.message + '\n\nSer√°s redirigido al inicio de sesi√≥n.');
          
          // Limpiar campos por seguridad
          newPasswordInput.value = '';
          confirmPasswordInput.value = '';
          
          // Redirigir despu√©s de un breve delay
          setTimeout(() => {
            window.location.href = "/login";
          }, 1000);
        } else {
          alert('‚ùå ' + (data.message || 'Error al actualizar contrase√±a'));
          confirmPasswordInput.value = '';
          confirmPasswordInput.focus();
        }
      } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error de conexi√≥n. Por favor, intenta de nuevo.');
      } finally {
        resetBtn.disabled = false;
        resetBtn.textContent = 'Guardar contrase√±a';
      }
    });

    // Auto-focus en el primer campo
    newPasswordInput?.focus();
  </script>

  <style>
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    section > div {
      animation: fadeInUp 0.4s ease;
    }

    input:focus {
      box-shadow: 0 0 0 3px rgba(160, 179, 139, 0.3);
      transition: all 0.2s ease;
    }

    /* Animaci√≥n de error */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s;
    }
  </style>
</Layout>
