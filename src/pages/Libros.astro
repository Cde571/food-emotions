---
import Layout from "../layouts/Layout.astro";
import ChatbotWidget from "../components/ChatbotWidget.astro";

// üîπ Si el usuario no busca nada, usamos la tem√°tica base de FoodEmotions
const userQuery = Astro.url.searchParams.get("search") || "";

// üî∏ Palabras clave base para mantener el enfoque en comida y salud emocional
const foodEmotionsTopics = "alimentaci√≥n saludable OR comida OR recetas OR nutrici√≥n OR bienestar OR emociones OR salud emocional";

// üîπ Combinamos la b√∫squeda del usuario con el filtro base
const query = userQuery
  ? `${userQuery} ${foodEmotionsTopics}`
  : foodEmotionsTopics;

const API_KEY = import.meta.env.PUBLIC_GOOGLE_BOOKS_KEY;

// üî∏ Limitamos los resultados a espa√±ol y temas de salud/comida
const res = await fetch(
  `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(
    query
  )}+subject:cooking+subject:health+subject:nutrition&langRestrict=es&maxResults=20&key=${API_KEY}`
);

const data = await res.json();
const books = data.items || [];
---

<Layout title="Books FoodEmotions">
  <section class="min-h-screen bg-gradient-to-br from-[#425638] via-[#516243] to-[#687450] text-white px-8 py-20 flex flex-col items-center justify-start">
    <!-- üîπ Header -->
    <div class="text-center mb-16">
      <h1 class="text-4xl font-bold mb-3">ü•ó Biblioteca FoodEmotions</h1>
      <p class="text-gray-200 text-lg max-w-2xl mx-auto">
        Descubre libros sobre <strong>alimentaci√≥n, bienestar y emociones</strong>.
        Todos los t√≠tulos est√°n filtrados para mantener la tem√°tica de <em>FoodEmotions</em>.
      </p>
    </div>

    <!-- üîπ Buscador -->
    <div class="flex justify-center mb-14 w-full">
      <form method="get" class="flex bg-white/10 backdrop-blur-md rounded-xl overflow-hidden w-full sm:w-2/3 md:w-1/2 shadow-[0_0_15px_#68745070]">
        <input
          type="text"
          name="search"
          placeholder="Buscar libro sobre comida o bienestar..."
          class="flex-1 bg-transparent px-4 py-3 text-white outline-none placeholder-gray-300"
        />
        <button class="bg-gradient-to-r from-[#687450] to-[#425638] px-6 py-2 hover:scale-105 transition">
          üîç
        </button>
      </form>
    </div>

    <!-- üîπ Grid de libros -->
    <div class="grid grid-cols-4 grid-rows-4 gap-0 max-w-[1200px] w-full h-[1200px] border-4 border-[#ffffff20] rounded-3xl overflow-hidden">
      {books.slice(0, 16).map((book, index) => {
        const info = book.volumeInfo || {};
        const cover =
          info.imageLinks?.thumbnail?.replace("&edge=curl", "") ||
          "https://via.placeholder.com/300x300?text=No+Cover";
        const title = info.title || "T√≠tulo no disponible";
        const author = info.authors
          ? info.authors.join(", ")
          : "Autor desconocido";
        const desc = info.description
          ? info.description.slice(0, 250) + "..."
          : "Sin descripci√≥n disponible.";
        const rating =
          info.averageRating || (Math.random() * 2 + 3.5).toFixed(1);
        const id = book.id;
        const previewLink = info.previewLink || "";
        const buyLink = book.saleInfo?.buyLink || "";
        const infoLink = info.infoLink || "";

        let gridClass = "";
        if (index === 0) gridClass = "col-span-1 row-span-2";
        else if (index === 1) gridClass = "col-span-2 row-span-2";
        else if (index === 2) gridClass = "col-span-1 row-span-1";
        else if (index === 3) gridClass = "col-span-1 row-span-2";
        else if (index === 6) gridClass = "col-span-2 row-span-2";
        else gridClass = "col-span-1 row-span-1";

        return (
          <div
            class={`book-card relative group ${gridClass} overflow-hidden cursor-pointer bg-gradient-to-br from-[#42563880] to-[#68745080] backdrop-blur-md transition-all duration-300 hover:z-10 hover:shadow-[0_0_30px_#687450]`}
            data-id={id}
            data-title={title}
            data-author={author}
            data-cover={cover}
            data-desc={desc}
            data-rating={rating}
            data-preview={previewLink}
            data-buy={buyLink}
            data-info={infoLink}
          >
            <img
              src={cover}
              alt={title}
              class="w-full h-full object-cover opacity-95 group-hover:opacity-100 group-hover:scale-105 transition-all duration-300"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-5">
              <h3 class="text-lg font-bold leading-tight line-clamp-2 mb-1 text-[#e7e9e1]">{title}</h3>
              <p class="text-sm text-[#cdd4c9] line-clamp-1">{author}</p>
            </div>
          </div>
        );
      })}
    </div>

    <!-- üîÆ Modal -->
    <div id="bookModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden justify-center items-center z-50 transition-all duration-500">
      <div id="modalContent" class="relative bg-gradient-to-br from-[#425638] via-[#516243] to-[#687450] p-10 rounded-3xl max-w-3xl w-11/12 transform scale-90 opacity-0 transition-all duration-300 shadow-[0_0_40px_#687450]">
        <button id="closeModal" class="absolute top-4 right-5 text-gray-200 hover:text-white text-2xl">‚úñ</button>

        <div class="flex flex-col md:flex-row items-center gap-8">
          <img id="modalCover" src="" alt="" class="w-56 h-80 object-cover rounded-2xl shadow-[0_0_25px_#687450]" />
          <div class="flex flex-col text-center md:text-left">
            <h2 id="modalTitle" class="text-3xl font-bold mb-3 text-[#e7e9e1]"></h2>
            <p id="modalAuthor" class="text-[#d4d8d0] mb-4"></p>
            <p id="modalDescription" class="text-[#f1f3f0] leading-relaxed mb-4 text-sm md:text-base"></p>
            <p id="modalRating" class="text-yellow-400 font-semibold text-lg mb-6"></p>

            <div class="flex flex-col sm:flex-row gap-3">
              <a id="previewBtn" href="#" target="_blank" rel="noopener noreferrer" class="hidden bg-gradient-to-r from-[#5d7350] to-[#687450] px-6 py-3 rounded-lg hover:scale-105 transition font-semibold text-center">
                üìñ Vista Previa
              </a>
              <a id="buyBtn" href="#" target="_blank" rel="noopener noreferrer" class="hidden bg-gradient-to-r from-[#687450] to-[#425638] px-6 py-3 rounded-lg hover:scale-105 transition font-semibold text-center">
                üí∞ Comprar
              </a>
              <a id="infoBtn" href="#" target="_blank" rel="noopener noreferrer" class="bg-gradient-to-r from-[#5e7053] to-[#8a9a74] px-6 py-3 rounded-lg hover:scale-105 transition font-semibold text-center">
                ‚ÑπÔ∏è M√°s Info
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Script (sin cambios) -->
  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("bookModal");
      const modalContent = document.getElementById("modalContent");
      const closeModal = document.getElementById("closeModal");

      const modalCover = document.getElementById("modalCover");
      const modalTitle = document.getElementById("modalTitle");
      const modalAuthor = document.getElementById("modalAuthor");
      const modalDescription = document.getElementById("modalDescription");
      const modalRating = document.getElementById("modalRating");

      const previewBtn = document.getElementById("previewBtn");
      const buyBtn = document.getElementById("buyBtn");
      const infoBtn = document.getElementById("infoBtn");

      document.querySelectorAll(".book-card").forEach((card) => {
        card.addEventListener("click", () => {
          modalCover.src = card.dataset.cover;
          modalTitle.textContent = card.dataset.title;
          modalAuthor.textContent = "‚úçÔ∏è " + card.dataset.author;
          modalDescription.textContent = card.dataset.desc;
          modalRating.textContent = "‚≠ê " + card.dataset.rating + "/5";

          const previewLink = card.dataset.preview;
          const buyLink = card.dataset.buy;
          const infoLink = card.dataset.info;

          if (previewLink) { previewBtn.href = previewLink; previewBtn.classList.remove("hidden"); } else previewBtn.classList.add("hidden");
          if (buyLink) { buyBtn.href = buyLink; buyBtn.classList.remove("hidden"); } else buyBtn.classList.add("hidden");
          if (infoLink) infoBtn.href = infoLink; else infoBtn.href = "#";

          modal.classList.remove("hidden");
          modal.classList.add("flex");
          setTimeout(() => {
            modalContent.classList.remove("opacity-0", "scale-90");
            modalContent.classList.add("opacity-100", "scale-100");
          }, 50);
        });
      });

      closeModal.addEventListener("click", () => {
        modalContent.classList.add("opacity-0", "scale-90");
        setTimeout(() => modal.classList.add("hidden"), 300);
      });

      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal.click();
      });
    });
  </script>
  <ChatbotWidget />
</Layout>







