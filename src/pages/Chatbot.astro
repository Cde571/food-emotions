---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Roy - Chatbot FoodEmotions">
  <section class="chatbot-section">
    <div class="chat-container">
      <!-- üîπ CABECERA -->
      <div class="chat-header">
        <img src="src/img/chatbot.png" alt="Roy Bot" class="bot-avatar" />
        <div class="bot-info">
          <h2>Roy <span class="status-indicator"></span></h2>
          <p class="bot-subtitle">Tu asistente emocional y saludable üå±</p>
        </div>
      </div>

      <!-- üîπ MODO DE CHAT -->
      <div class="mode-selector">
        <button class="mode-btn active" data-mode="general">üí¨ General</button>
        <button class="mode-btn" data-mode="emocional">‚ù§Ô∏è Emocional</button>
        <button class="mode-btn" data-mode="chef">üç≥ Chef</button>
        <button class="mode-btn" data-mode="musical">üéµ Musical</button>
      </div>

      <!-- üîπ CAJA DE CHAT -->
      <div id="chat-box" class="chat-box">
        <div class="welcome-message">
          <p>üëã ¬°Hola! Soy <strong>Roy</strong>, tu asistente de bienestar.</p>
          <p>Cu√©ntame c√≥mo te sientes o qu√© quieres preparar hoy üç≤</p>
        </div>
      </div>

      <!-- üîπ INPUT -->
      <div class="chat-input-container">
        <textarea 
          id="chat-input" 
          placeholder="Escribe tu mensaje..." 
          rows="1"
        ></textarea>
        <button id="send-btn" aria-label="Enviar mensaje">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
          </svg>
        </button>
      </div>

      <!-- üîπ INDICADOR DE ESCRITURA -->
      <div class="typing-indicator" style="display:none;">
        <span></span><span></span><span></span>
      </div>
    </div>
  </section>

  <script is:inline>
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("chat-input");
    const btn = document.getElementById("send-btn");
    const typingIndicator = document.querySelector(".typing-indicator");
    const modeButtons = document.querySelectorAll(".mode-btn");
    let currentMode = "general";

    // Selector de modo
    modeButtons.forEach(b=>{
      b.addEventListener("click",()=>{
        modeButtons.forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        currentMode = b.dataset.mode;
        addSystemMessage(`üåø Modo cambiado a: ${b.textContent}`);
      });
    });

    input.addEventListener("input",()=>{
      input.style.height="auto";
      input.style.height=Math.min(input.scrollHeight,120)+"px";
    });

    function addSystemMessage(text){
      const sys=document.createElement("div");
      sys.className="message system";
      sys.textContent=text;
      chatBox.appendChild(sys);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    function addUserMessage(text){
      const m=document.createElement("div");
      m.className="message user";
      m.innerHTML=`
        <div class="message-content">${text}</div>
        <div class="message-time">${new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})}</div>
      `;
      chatBox.appendChild(m);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    function addBotMessage(text,emotion="neutral"){
      const eMap={happy:"üòä",sad:"üòî",angry:"üò†",calm:"üòå",neutral:"ü§ñ"};
      const m=document.createElement("div");
      m.className="message bot";
      m.innerHTML=`
        <div class="bot-avatar-small"><img src="/img/chatbot.png" alt="Roy" /></div>
        <div class="message-bubble">
          <div class="message-content">${text}</div>
          <div class="message-footer">
            <span class="emotion-badge">${eMap[emotion]||"ü§ñ"}</span>
            <span class="message-time">${new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})}</span>
          </div>
        </div>`;
      chatBox.appendChild(m);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    function showTyping(){typingIndicator.style.display="flex";}
    function hideTyping(){typingIndicator.style.display="none";}

    async function sendMessage(){
      const text=input.value.trim();
      if(!text)return;
      addUserMessage(text);
      input.value="";
      input.style.height="auto";
      btn.disabled=true;
      showTyping();

      try{
        const res=await fetch("http://localhost:3000/api/chat/voice",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({message:text,mode:currentMode})
        });
        const data=await res.json();
        hideTyping();
        if(res.ok){
          addBotMessage(data.reply||"No pude procesar tu mensaje.",data.emotion);
          if(data.audioUrl){
            const a=new Audio(`http://localhost:3000${data.audioUrl}`);
            a.play();
          }
        }else{
          addBotMessage("‚ö†Ô∏è Error al procesar el mensaje.","neutral");
        }
      }catch(e){
        hideTyping();
        addBotMessage("‚ùå Error de conexi√≥n.","neutral");
      }
      btn.disabled=false;
    }

    btn.addEventListener("click",sendMessage);
    input.addEventListener("keydown",e=>{
      if(e.key==="Enter"&&!e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
  </script>

  <style>
    *{box-sizing:border-box;}
    body{font-family:'Poppins',sans-serif;}

    .chatbot-section{
      background:linear-gradient(135deg,#687450 0%,#425638 80%);
      min-height:calc(100vh - 60px);
      display:flex;
      justify-content:center;
      align-items:center;
      padding:3rem 1rem;
    }

    .chat-container{
      background:rgba(255,255,255,0.15);
      border:2px solid #a5b78a;
      border-radius:20px;
      box-shadow:0 0 30px rgba(66,86,56,0.5), inset 0 0 15px rgba(255,255,255,0.1);
      width:100%;
      max-width:720px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter:blur(10px);
    }

    .chat-header{
      display:flex;
      align-items:center;
      gap:1rem;
      padding:1rem 1.5rem;
      background:linear-gradient(90deg,#425638,#687450);
      border-bottom:2px solid #d0dbb8;
      text-shadow:0 0 6px rgba(255,255,255,0.4);
    }

    .bot-avatar{width:56px;height:56px;border-radius:50%;border:3px solid #dfe6d3;box-shadow:0 0 10px rgba(223,230,211,0.7);}
    .bot-info h2{color:#fff;font-size:1.4rem;margin:0;font-weight:700;}
    .bot-subtitle{font-size:.85rem;color:#e2e7d9;}
    .status-indicator{width:10px;height:10px;background:#c8e6a0;border-radius:50%;animation:pulse 1.5s infinite;}
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}

    .mode-selector{
      display:flex;
      gap:.5rem;
      padding:.8rem;
      background:rgba(255,255,255,0.15);
      border-bottom:1px solid rgba(255,255,255,0.2);
      justify-content:center;
    }

    .mode-btn{
      padding:.45rem 1rem;
      border:1px solid #c5d1aa;
      background:rgba(255,255,255,0.15);
      color:#f6f9f1;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      transition:all .3s;
    }

    .mode-btn.active,.mode-btn:hover{
      background:#dce7c3;
      color:#425638;
      transform:scale(1.05);
      box-shadow:0 0 8px rgba(255,255,255,0.5);
    }

    .chat-box{
      flex:1;
      padding:1rem;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:1rem;
      background:rgba(255,255,255,0.08);
      scroll-behavior:smooth;
    }

    .chat-box::-webkit-scrollbar{width:6px;}
    .chat-box::-webkit-scrollbar-thumb{background:#a5b78a;border-radius:3px;}

    .welcome-message{text-align:center;color:#eef1e8;font-size:.9rem;margin-top:1rem;}

    .message{display:flex;gap:.6rem;animation:fadeIn .3s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

    .message.user{justify-content:flex-end;}
    .message.user .message-content{
      background:linear-gradient(135deg,#687450,#425638);
      color:#fff;
      padding:.8rem 1rem;
      border-radius:16px 16px 4px 16px;
      box-shadow:0 0 10px rgba(66,86,56,0.4);
      max-width:75%;
    }

    .message.bot{align-items:flex-start;}
    .bot-avatar-small{width:32px;height:32px;flex-shrink:0;}
    .bot-avatar-small img{width:100%;height:100%;border-radius:50%;border:2px solid #cdd9b8;}
    .message-bubble{
      background:rgba(255,255,255,0.3);
      padding:.8rem 1rem;
      border-radius:4px 16px 16px 16px;
      max-width:75%;
      border:1px solid rgba(255,255,255,0.25);
      box-shadow:inset 0 0 10px rgba(255,255,255,0.1);
    }

    .message-content{color:#28331d;line-height:1.5;}
    .message-footer{display:flex;gap:.4rem;margin-top:.3rem;font-size:.7rem;color:#425638;font-weight:600;}
    .message.system{text-align:center;width:100%;color:#e2ead3;font-size:.75rem;font-style:italic;}

    .typing-indicator{display:flex;gap:5px;padding:.8rem;justify-content:center;}
    .typing-indicator span{width:8px;height:8px;background:#dce7c3;border-radius:50%;animation:typing 1.4s infinite;}
    .typing-indicator span:nth-child(2){animation-delay:.2s;}
    .typing-indicator span:nth-child(3){animation-delay:.4s;}
    @keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.6;}30%{transform:translateY(-8px);opacity:1;}}

    .chat-input-container{
      display:flex;
      gap:.6rem;
      padding:1rem;
      background:rgba(255,255,255,0.15);
      border-top:1px solid rgba(255,255,255,0.2);
    }

    #chat-input{
      flex:1;
      padding:.6rem .8rem;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.3);
      background:rgba(255,255,255,0.7);
      color:#28331d;
      font-size:.9rem;
      resize:none;
      outline:none;
      transition:border .3s;
    }

    #chat-input:focus{
      border-color:#687450;
      box-shadow:0 0 8px rgba(66,86,56,0.4);
    }

    #chat-input::placeholder{color:#687450;}
    #send-btn{
      width:48px;height:48px;
      border:none;
      border-radius:12px;
      background:linear-gradient(135deg,#687450,#425638);
      color:white;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:all .3s;
    }

    #send-btn:hover{transform:scale(1.1);box-shadow:0 0 12px rgba(255,255,255,0.4);}
  </style>
</Layout>








