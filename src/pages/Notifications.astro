---
// src/pages/Notifications.astro
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/shared/Navigation.astro';
---

<Layout title="Notificaciones">
  <Navigation />

  <div class="notifications-container">
    <div class="notifications-wrapper">
      <div class="notifications-header">
        <h1>Notificaciones</h1>
        <div class="header-actions">
          <button id="mark-all-read" class="action-btn">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Marcar todas como le칤das
          </button>
          <button id="filter-btn" class="action-btn">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
            Filtrar
          </button>
        </div>
      </div>

      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">Todas</button>
        <button class="filter-tab" data-filter="likes">Likes</button>
        <button class="filter-tab" data-filter="comments">Comentarios</button>
        <button class="filter-tab" data-filter="follows">Seguidores</button>
        <button class="filter-tab" data-filter="mentions">Menciones</button>
      </div>

      <div id="notifications-list" class="notifications-list">
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Cargando notificaciones...</p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import socketClient from '../scripts/websocket/socketClient.js';

  const token = localStorage.getItem('authToken');
  let currentFilter = 'all';

  async function loadNotifications(filter = 'all') {
    try {
      const response = await fetch(`/api/notifications?filter=${filter}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const notifications = await response.json();

      const listContainer = document.getElementById('notifications-list');
      
      if (notifications.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <h3>No tienes notificaciones</h3>
            <p>Cuando alguien interact칰e con tu contenido, lo ver치s aqu칤</p>
          </div>
        `;
        return;
      }

      listContainer.innerHTML = notifications.map(notif => createNotificationItem(notif)).join('');

      // Event listeners
      document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', () => handleNotificationClick(item.dataset.notifId, item.dataset.type, item.dataset.targetId));
      });

      document.querySelectorAll('.delete-notif-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          await deleteNotification(btn.dataset.notifId);
        });
      });

    } catch (error) {
      console.error('Error al cargar notificaciones:', error);
      document.getElementById('notifications-list').innerHTML = `
        <div class="error-state">
          <p>Error al cargar notificaciones</p>
          <button onclick="location.reload()">Reintentar</button>
        </div>
      `;
    }
  }

  function createNotificationItem(notif) {
    const icons = {
      like: '仇벒잺',
      comment: '游눫',
      follow: '游녻',
      mention: '@'
    };

    const messages = {
      like: 'le gust칩 tu publicaci칩n',
      comment: 'coment칩 en tu publicaci칩n',
      follow: 'comenz칩 a seguirte',
      mention: 'te mencion칩 en una publicaci칩n'
    };

    return `
      <div class="notification-item ${notif.isRead ? 'read' : 'unread'}" 
           data-notif-id="${notif._id}"
           data-type="${notif.type}"
           data-target-id="${notif.post?._id || notif.sender._id}">
        <div class="notif-icon ${notif.type}">
          ${icons[notif.type]}
        </div>
        <img src="${notif.sender.profilePic || `https://ui-avatars.com/api/?name=${notif.sender.username}`}" 
             alt="${notif.sender.username}" 
             class="notif-avatar" />
        <div class="notif-content">
          <p class="notif-text">
            <strong>${notif.sender.username}</strong> ${messages[notif.type]}
          </p>
          <span class="notif-time">${formatTime(notif.createdAt)}</span>
        </div>
        ${notif.post?.images?.[0] ? `
          <img src="${notif.post.images[0]}" alt="Post" class="notif-thumbnail" />
        ` : ''}
        ${!notif.isRead ? '<div class="unread-dot"></div>' : ''}
        <button class="delete-notif-btn" data-notif-id="${notif._id}" title="Eliminar">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    `;
  }

  async function handleNotificationClick(notifId, type, targetId) {
    try {
      // Marcar como le칤da
      await fetch(`/api/notifications/${notifId}/read`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      // Navegar seg칰n el tipo
      switch (type) {
        case 'like':
        case 'comment':
        case 'mention':
          window.location.href = `/Post/${targetId}`;
          break;
        case 'follow':
          window.location.href = `/Profile/${targetId}`;
          break;
      }
    } catch (error) {
      console.error('Error:', error);
    }
  }

  async function deleteNotification(notifId) {
    try {
      await fetch(`/api/notifications/${notifId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      document.querySelector(`[data-notif-id="${notifId}"]`)?.remove();

      // Verificar si est치 vac칤o
      const list = document.getElementById('notifications-list');
      if (!list.querySelector('.notification-item')) {
        list.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 01-3.46 0"/>
            </svg>
            <h3>No tienes notificaciones</h3>
            <p>Cuando alguien interact칰e con tu contenido, lo ver치s aqu칤</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error al eliminar notificaci칩n:', error);
    }
  }

  // Marcar todas como le칤das
  document.getElementById('mark-all-read')?.addEventListener('click', async () => {
    try {
      await fetch('/api/notifications/read-all', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      document.querySelectorAll('.notification-item.unread').forEach(item => {
        item.classList.remove('unread');
        item.classList.add('read');
        item.querySelector('.unread-dot')?.remove();
      });

      // Actualizar badge en navbar
      const badge = document.getElementById('notif-badge-nav');
      if (badge) {
        badge.textContent = '0';
        badge.classList.add('hidden');
      }
    } catch (error) {
      console.error('Error:', error);
    }
  });

  // Filtros
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentFilter = tab.dataset.filter;
      loadNotifications(currentFilter);
    });
  });

  function formatTime(timestamp) {
    const now = new Date();
    const date = new Date(timestamp);
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'Ahora mismo';
    if (minutes < 60) return `Hace ${minutes}m`;
    if (hours < 24) return `Hace ${hours}h`;
    if (days < 7) return `Hace ${days}d`;
    return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
  }

  // WebSocket para notificaciones en tiempo real
  socketClient.on('notification', (notification) => {
    const list = document.getElementById('notifications-list');
    const emptyState = list.querySelector('.empty-state');
    
    if (emptyState) {
      list.innerHTML = '';
    }

    list.insertAdjacentHTML('afterbegin', createNotificationItem(notification));

    // Agregar event listener al nuevo item
    const newItem = list.querySelector('.notification-item');
    newItem.addEventListener('click', () => handleNotificationClick(notification._id, notification.type, notification.post?._id || notification.sender._id));
  });

  // Inicializar
  loadNotifications();
</script>

<style>
  :root {
    --primary: #667BC6;
    --secondary: #DA7297;
    --dark: #2d2d2d;
    --gray: #6b7280;
    --gray-light: #f3f4f6;
    --border: #e5e7eb;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;
    --card-bg: #ffffff;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    --radius: 12px;
  }

  .notifications-container {
    max-width: 800px;
    margin: 90px auto 40px;
    padding: 0 24px;
  }

  .notifications-wrapper {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .notifications-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .notifications-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--dark);
    margin: 0;
  }

  .header-actions {
    display: flex;
    gap: 12px;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--gray-light);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray);
    cursor: pointer;
    transition: all 0.2s;
  }

  .action-btn:hover {
    background: white;
    border-color: var(--primary);
    color: var(--primary);
  }

  .filter-tabs {
    display: flex;
    gap: 8px;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
  }

  .filter-tabs::-webkit-scrollbar {
    display: none;
  }

  .filter-tab {
    padding: 8px 16px;
    background: none;
    border: none;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
  }

  .filter-tab:hover {
    background: var(--gray-light);
    color: var(--dark);
  }

  .filter-tab.active {
    background: var(--primary);
    color: white;
  }

  .notifications-list {
    min-height: 400px;
  }

  .notification-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
  }

  .notification-item:last-child {
    border-bottom: none;
  }

  .notification-item:hover {
    background: var(--gray-light);
  }

  .notification-item.unread {
    background: rgba(102, 123, 198, 0.05);
  }

  .notif-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }

  .notif-icon.like {
    background: #fee2e2;
  }

  .notif-icon.comment {
    background: #dbeafe;
  }

  .notif-icon.follow {
    background: #dcfce7;
  }

  .notif-icon.mention {
    background: #fef3c7;
  }

  .notif-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .notif-content {
    flex: 1;
    min-width: 0;
  }

  .notif-text {
    font-size: 15px;
    color: var(--dark);
    margin: 0 0 4px;
  }

  .notif-text strong {
    font-weight: 600;
  }

  .notif-time {
    font-size: 13px;
    color: var(--gray);
  }

  .notif-thumbnail {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .unread-dot {
    width: 10px;
    height: 10px;
    background: var(--primary);
    border-radius: 50%;
    flex-shrink: 0;
  }

  .delete-notif-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--gray);
    opacity: 0;
    transition: all 0.2s;
  }

  .notification-item:hover .delete-notif-btn {
    opacity: 1;
  }

  .delete-notif-btn:hover {
    background: var(--error);
    color: white;
  }

  .loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .empty-state {
    text-align: center;
    padding: 80px 40px;
    color: var(--gray);
  }

  .empty-state svg {
    margin-bottom: 20px;
  }

  .empty-state h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--dark);
    margin: 0 0 8px;
  }

  .empty-state p {
    font-size: 15px;
    margin: 0;
  }

  .error-state {
    text-align: center;
    padding: 80px 40px;
  }

  .error-state p {
    color: var(--error);
    font-size: 16px;
    margin-bottom: 16px;
  }

  .error-state button {
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .error-state button:hover {
    background: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  @media (max-width: 640px) {
    .notifications-container {
      padding: 0;
      margin-top: 70px;
    }

    .notifications-wrapper {
      border-radius: 0;
    }

    .notifications-header {
      padding: 16px;
    }

    .notifications-header h1 {
      font-size: 22px;
    }

    .header-actions {
      width: 100%;
    }

    .action-btn {
      flex: 1;
      justify-content: center;
      font-size: 13px;
      padding: 8px 12px;
    }

    .filter-tabs {
      padding: 12px 16px;
    }

    .notification-item {
      padding: 12px 16px;
    }

    .notif-thumbnail {
      display: none;
    }
  }
</style>