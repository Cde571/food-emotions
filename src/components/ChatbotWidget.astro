---
import { onMount } from "astro/jsx-runtime";
---

<!-- ðŸ”¹ BOTÃ“N FLOTANTE -->
<div 
  id="royWidgetBtn" 
  class="fixed bottom-6 right-6 bg-gradient-to-r from-[#687450] to-[#425638] text-white p-4 rounded-full shadow-lg hover:scale-110 transition cursor-pointer z-50"
  title="Habla con Roy ðŸ¤–"
>
  ðŸ¤–
</div>

<!-- ðŸ”¹ CHAT WIDGET (No modal, fijo) -->
<div 
  id="royChatContainer" 
  class="fixed bottom-20 right-6 w-80 max-h-[70vh] bg-gradient-to-br from-[#425638] via-[#556844] to-[#687450] text-white rounded-2xl shadow-2xl hidden flex-col overflow-hidden z-50 border border-[#a0b38b40]"
>
  <!-- Header -->
  <div class="flex justify-between items-center p-3 bg-[#374730]/80 border-b border-white/20">
    <div class="flex items-center gap-3">
      <img src="/src/img/chatbot.png" alt="Roy" class="w-8 h-8 rounded-full border border-white/30" />
      <div>
        <h2 class="font-semibold text-sm">Roy</h2>
        <p class="text-[10px] text-gray-200">Asistente emocional</p>
      </div>
    </div>
    <button id="closeRoy" class="text-gray-300 hover:text-white text-lg leading-none">Ã—</button>
  </div>

  <!-- Chat -->
  <div id="royChatBox" class="flex-1 p-3 space-y-2 overflow-y-auto text-sm bg-white/5">
    <div class="text-gray-300 text-center mt-2">ðŸ‘‹ Â¡Hola! Soy Roy, Â¿cÃ³mo te sientes hoy?</div>
  </div>

  <!-- Input -->
  <div class="p-2 border-t border-white/20 flex gap-2 items-center bg-white/10">
    <textarea 
      id="royInput" 
      class="flex-1 bg-transparent border-none outline-none text-sm resize-none h-10 text-white placeholder-gray-300" 
      placeholder="Escribe aquÃ­..."
    ></textarea>
    <button 
      id="roySendBtn" 
      class="bg-gradient-to-r from-[#687450] to-[#425638] px-3 py-2 rounded-lg hover:scale-105 transition"
      title="Enviar"
    >
      ðŸ“©
    </button>
  </div>
</div>

<script is:inline>
  const widgetBtn = document.getElementById("royWidgetBtn");
  const chatContainer = document.getElementById("royChatContainer");
  const closeBtn = document.getElementById("closeRoy");
  const sendBtn = document.getElementById("roySendBtn");
  const input = document.getElementById("royInput");
  const chatBox = document.getElementById("royChatBox");

  widgetBtn.addEventListener("click", () => {
    chatContainer.classList.toggle("hidden");
  });

  closeBtn.addEventListener("click", () => {
    chatContainer.classList.add("hidden");
  });

  function addMessage(content, sender = "bot") {
    const msg = document.createElement("div");
    msg.className = sender === "bot" ? "text-left" : "text-right";
    msg.innerHTML = `
      <div class="inline-block px-3 py-2 rounded-xl mb-1 max-w-[80%] ${
        sender === "bot"
          ? "bg-white/20 text-[#eaf0e3]"
          : "bg-[#a0b38b]/70 text-white"
      }">${content}</div>
    `;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addMessage(text, "user");
  input.value = "";

  // Mensaje temporal de "escribiendo..."
  addMessage("Roy estÃ¡ escribiendo...", "bot");

  try {
    const res = await fetch("http://localhost:3000/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, mode: "general" }),
    });

    const data = await res.json();

    // Eliminar el mensaje temporal
    if (chatBox.lastChild) chatBox.lastChild.remove();

    const reply = data.reply || "No pude procesar tu mensaje.";
    addMessage(reply, "bot");

  } catch (err) {
    if (chatBox.lastChild) chatBox.lastChild.remove();
    addMessage("âŒ Error al conectar con el servidor.", "bot");
  }
}

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>

<style>
  #royChatBox::-webkit-scrollbar {
    width: 6px;
  }
  #royChatBox::-webkit-scrollbar-thumb {
    background: #a0b38b;
    border-radius: 3px;
  }
  #royChatBox::-webkit-scrollbar-track {
    background: transparent;
  }

  /* PequeÃ±a animaciÃ³n al abrir */
  #royChatContainer {
    animation: fadeInUp 0.25s ease;
  }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
