---
// src/components/social/PostModal.astro
---

<div id="post-modal" class="modal-overlay hidden">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">Crear Publicaci√≥n</h2>
      <button class="modal-close" id="close-modal-btn" type="button">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <form id="create-post-form" class="modal-body">
      <div class="user-info">
        <img id="modal-user-avatar" src="" alt="Avatar" class="modal-avatar" />
        <div class="user-details">
          <span id="modal-username" class="username">Usuario</span>
          <select id="post-visibility" name="visibility" class="privacy-select">
            <option value="public">üåç P√∫blico</option>
            <option value="followers">üë• Seguidores</option>
            <option value="private">üîí Privado</option>
          </select>
        </div>
      </div>

      <div class="post-input-wrapper">
        <textarea 
          id="post-caption" 
          name="caption"
          class="post-textarea" 
          placeholder="¬øQu√© est√°s pensando?"
          maxlength="2000"
          rows="6"
        ></textarea>
        <div class="char-counter">
          <span id="char-count">0</span> / 2000
        </div>
      </div>

      <div id="image-preview-container" class="media-preview"></div>

      <div class="post-actions-bar">
        <button type="button" class="action-btn" id="upload-image-btn" title="Agregar foto/video">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          <span>Foto/Video</span>
        </button>

        <button type="button" class="action-btn" id="add-emoji-btn" title="Agregar emoji">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
            <line x1="9" y1="9" x2="9.01" y2="9"/>
            <line x1="15" y1="9" x2="15.01" y2="9"/>
          </svg>
          <span>Emoji</span>
        </button>

        <button type="button" class="action-btn" id="add-location-btn" title="Agregar ubicaci√≥n">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <span>Ubicaci√≥n</span>
        </button>

        <button type="button" class="action-btn" id="add-tags-btn" title="Agregar etiquetas">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/>
            <line x1="7" y1="7" x2="7.01" y2="7"/>
          </svg>
          <span>Etiquetas</span>
        </button>
      </div>

      <input 
        type="file" 
        id="post-images" 
        name="images"
        accept="image/*,video/*" 
        multiple 
        style="display: none;"
      />

      <div class="location-input hidden" id="location-input">
        <input 
          type="text" 
          id="location-text" 
          name="location"
          class="location-field" 
          placeholder="¬øD√≥nde est√°s?"
          autocomplete="off"
        />
        <button type="button" class="remove-location" id="remove-location">√ó</button>
      </div>

      <div class="tags-input hidden" id="tags-input">
        <div class="tags-container" id="tags-container"></div>
        <input 
          type="text" 
          id="tag-text" 
          class="tag-field" 
          placeholder="Agregar etiqueta (presiona Enter)"
        />
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" id="cancel-post-btn">Cancelar</button>
        <button type="submit" class="btn-publish" id="publish-post-btn" disabled>
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
          Publicar
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const API_URL = 'http://localhost:3000';
  let selectedTags: string[] = [];
  let selectedFiles: File[] = []; // Almacenar archivos manualmente
  let selectedLocation: any = null;
  let locationTimeout: any;

  // üßë‚Äçüç≥ Usuario actual cacheado (igual idea que en Profile.astro)
let cachedUser: any = null;

async function getCurrentUser() {
  if (cachedUser) return cachedUser;

  const res = await fetch(`${API_URL}/api/user/me`, {
    credentials: 'include',
    headers: { Accept: 'application/json' }
  });

  if (!res.ok) {
    if (res.status === 401) {
      window.location.href = '/login';
      return null;
    }
    throw new Error('Error obteniendo usuario actual');
  }

  const me = await res.json();

  if (!me.loggedIn) {
    window.location.href = '/login';
    return null;
  }

  cachedUser = me;

  // Guardamos tambi√©n en localStorage para reutilizar en otras partes
  if (me.username) localStorage.setItem('fe_username', me.username);
  if (me.profilePic) localStorage.setItem('fe_profilePic', me.profilePic);

  return me;
}

  // ============================================================
  // üîß ELEMENTOS DEL DOM
  // ============================================================
  const modal = document.getElementById('post-modal');
  const form = document.getElementById('create-post-form');
  const closeBtn = document.getElementById('close-modal-btn');
  const cancelBtn = document.getElementById('cancel-post-btn');
  const publishBtn = document.getElementById('publish-post-btn') as HTMLButtonElement;
  const captionInput = document.getElementById('post-caption') as HTMLTextAreaElement;
  const charCount = document.getElementById('char-count');
  const fileInput = document.getElementById('post-images') as HTMLInputElement;
  const uploadBtn = document.getElementById('upload-image-btn');
  const mediaPreview = document.getElementById('image-preview-container');
  const locationBtn = document.getElementById('add-location-btn');
  const locationInput = document.getElementById('location-input');
  const locationText = document.getElementById('location-text') as HTMLInputElement;
  const removeLocationBtn = document.getElementById('remove-location');
  const tagsBtn = document.getElementById('add-tags-btn');
  const tagsInputDiv = document.getElementById('tags-input');
  const tagText = document.getElementById('tag-text') as HTMLInputElement;
  const tagsContainer = document.getElementById('tags-container');
  const emojiBtn = document.getElementById('add-emoji-btn');


// ============================================================
// üë§ CARGAR DATOS DEL USUARIO
// ============================================================
async function loadModalUserData() {
  try {
    console.log('üîÑ Cargando datos para modal de post...');

    const user = await getCurrentUser();
    if (!user) return;

    const modalAvatar = document.getElementById('modal-user-avatar') as HTMLImageElement | null;
    const modalUsername = document.getElementById('modal-username') as HTMLElement | null;

    const username =
      user.username ||
      localStorage.getItem('fe_username') ||
      'Usuario';

    const avatarUrl =
      user.profilePic ||
      localStorage.getItem('fe_profilePic') ||
      `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=687450&color=fff&size=48`;

    if (modalAvatar) modalAvatar.src = avatarUrl;
    if (modalUsername) modalUsername.textContent = username;

    console.log('‚úÖ Usuario cargado en modal:', { username, avatarUrl });
  } catch (error) {
    console.error('‚ùå Error cargando usuario en modal:', error);
  }
}

  // ============================================================
  // üéØ FUNCIONES DEL MODAL
  // ============================================================
  function openModal() {
    if (!modal) return;
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadModalUserData();
    console.log('‚úÖ Modal abierto');
  }

  function closeModal() {
    if (!modal) return;
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    resetForm();
    console.log('‚úÖ Modal cerrado');
  }

  function resetForm() {
    if (form) form.reset();
    if (charCount) charCount.textContent = '0';
    if (mediaPreview) mediaPreview.innerHTML = '';
    if (locationInput) locationInput.classList.add('hidden');
    if (tagsInputDiv) tagsInputDiv.classList.add('hidden');
    if (tagsContainer) tagsContainer.innerHTML = '';
    if (locationText) locationText.value = '';
    selectedTags = [];
    selectedFiles = []; // Limpiar archivos
    selectedLocation = null;
    if (publishBtn) publishBtn.disabled = true;
    
    // Cerrar emoji picker
    const picker = document.getElementById('emoji-picker');
    if (picker) picker.classList.add('hidden');
    
    // Limpiar sugerencias de ubicaci√≥n
    const suggestions = document.getElementById('location-suggestions');
    if (suggestions) suggestions.remove();
    
    console.log('üßπ Formulario reseteado');
  }

  // ============================================================
  // üìù CONTADOR DE CARACTERES
  // ============================================================
  captionInput?.addEventListener('input', (e) => {
    const length = (e.target as HTMLTextAreaElement).value.length;
    if (charCount) {
      charCount.textContent = length.toString();
      charCount.style.color = length > 1900 ? '#ef4444' : '#6b7280';
    }
    validateForm();
  });

  // ============================================================
  // ‚úÖ VALIDAR FORMULARIO
  // ============================================================
  function validateForm() {
    const hasCaption = captionInput?.value.trim().length > 0;
    const hasFiles = selectedFiles.length > 0;
    const hasContent = hasCaption || hasFiles;
    
    if (publishBtn) {
      publishBtn.disabled = !hasContent;
    }
  }

  // ============================================================
  // üì∑ MANEJO DE IM√ÅGENES (CORREGIDO)
  // ============================================================
  uploadBtn?.addEventListener('click', () => {
    fileInput?.click();
  });

  fileInput?.addEventListener('change', (e) => {
    const files = Array.from((e.target as HTMLInputElement).files || []);
    
    console.log(`üì∏ ${files.length} archivos nuevos seleccionados`);

    if (selectedFiles.length + files.length > 10) {
      showToast('M√°ximo 10 archivos por publicaci√≥n', 'error');
      return;
    }

    files.forEach((file) => {
      if (file.size > 10 * 1024 * 1024) {
        showToast(`Archivo ${file.name} muy grande (m√°x 10MB)`, 'error');
        return;
      }

      // Agregar archivo al array
      selectedFiles.push(file);
    });

    // Limpiar el input para permitir agregar el mismo archivo de nuevo
    if (fileInput) fileInput.value = '';

    // Renderizar preview
    renderMediaPreview();
    validateForm();
  });

  function renderMediaPreview() {
    if (!mediaPreview) return;
    
    mediaPreview.innerHTML = '';

    selectedFiles.forEach((file, index) => {
      addMediaPreview(file, index);
    });
  }

  function addMediaPreview(file: File, index: number) {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      const preview = document.createElement('div');
      preview.className = 'media-item';
      preview.dataset.index = index.toString();
      
      preview.innerHTML = `
        <img src="${e.target?.result}" alt="Preview ${index + 1}" loading="lazy" />
        <button type="button" class="remove-media" data-index="${index}" title="Eliminar">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="white" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
        <div class="media-number">${index + 1}</div>
      `;
      
      const removeBtn = preview.querySelector('.remove-media');
      removeBtn?.addEventListener('click', () => {
        removeMedia(index);
      });

      mediaPreview?.appendChild(preview);
    };

    reader.readAsDataURL(file);
  }

  function removeMedia(indexToRemove: number) {
    // Eliminar del array
    selectedFiles.splice(indexToRemove, 1);
    
    console.log(`üóëÔ∏è Imagen ${indexToRemove + 1} eliminada. Total: ${selectedFiles.length}`);
    
    // Re-renderizar preview
    renderMediaPreview();
    validateForm();
  }

  // ============================================================
  // üìç UBICACI√ìN CON AUTOCOMPLETADO
  // ============================================================
  locationBtn?.addEventListener('click', () => {
    locationInput?.classList.toggle('hidden');
    if (!locationInput?.classList.contains('hidden')) {
      locationText?.focus();
    }
  });

  removeLocationBtn?.addEventListener('click', () => {
    locationInput?.classList.add('hidden');
    if (locationText) locationText.value = '';
    selectedLocation = null;
    const suggestions = document.getElementById('location-suggestions');
    if (suggestions) suggestions.remove();
  });

  // Buscar ubicaciones mientras el usuario escribe
  locationText?.addEventListener('input', async (e) => {
    const query = (e.target as HTMLInputElement).value.trim();
    
    // Limpiar timeout anterior
    clearTimeout(locationTimeout);
    
    // Remover sugerencias anteriores
    let suggestions = document.getElementById('location-suggestions');
    if (suggestions) suggestions.remove();
    
    if (query.length < 2) return;
    
    // Esperar 500ms antes de buscar
    locationTimeout = setTimeout(async () => {
      try {
        // Usar Nominatim de OpenStreetMap para geocoding gratuito
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
          {
            headers: {
              'Accept': 'application/json',
              'User-Agent': 'SocialApp/1.0'
            }
          }
        );
        
        if (!response.ok) return;
        
        const places = await response.json();
        
        if (places.length > 0) {
          showLocationSuggestions(places);
        }
      } catch (error) {
        console.error('Error buscando ubicaciones:', error);
      }
    }, 500);
  });

  function showLocationSuggestions(places: any[]) {
    // Crear contenedor de sugerencias
    let suggestions = document.getElementById('location-suggestions');
    if (!suggestions) {
      suggestions = document.createElement('div');
      suggestions.id = 'location-suggestions';
      suggestions.className = 'location-suggestions';
      locationInput?.appendChild(suggestions);
    } else {
      suggestions.innerHTML = '';
    }
    
    places.forEach(place => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'location-suggestion-item';
      
      const address = place.address;
      const city = address.city || address.town || address.village || '';
      const country = address.country || '';
      
      item.innerHTML = `
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
          <circle cx="12" cy="10" r="3"/>
        </svg>
        <div class="location-suggestion-text">
          <div class="location-name">${place.display_name.split(',').slice(0, 2).join(',')}</div>
          <div class="location-detail">${city ? city + ', ' : ''}${country}</div>
        </div>
      `;
      
      item.addEventListener('click', () => {
        selectedLocation = {
          name: place.display_name,
          lat: place.lat,
          lng: place.lon,
          city: city,
          country: country
        };
        
        if (locationText) {
          locationText.value = `${city ? city + ', ' : ''}${country}`;
        }
        
        suggestions?.remove();
        console.log('üìç Ubicaci√≥n seleccionada:', selectedLocation);
      });
      
      suggestions.appendChild(item);
    });
  }

  // ============================================================
  // üòÄ SELECTOR DE EMOJIS
  // ============================================================
  const emojis = [
    'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ',
    'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã',
    'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü•≥', 'ü§©',
    'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ',
    'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø',
    'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î',
    'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶',
    'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥',
    'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà', 'üëø',
    'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ',
    'üéÉ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ',
    '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî',
    '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è',
    '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê',
    '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê',
    'üëç', 'üëé', 'üëä', '‚úä', 'ü§õ', 'ü§ú', 'ü§û', '‚úåÔ∏è', 'ü§ü', 'ü§ò',
    'üëå', 'ü§å', 'ü§è', 'üëà', 'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', '‚úã', 'ü§ö',
    'üñêÔ∏è', 'üññ', 'üëã', 'ü§ô', 'üí™', 'ü¶æ', 'üñï', '‚úçÔ∏è', 'üôè', 'ü¶∂',
    'üî•', '‚≠ê', '‚ú®', 'üí´', '‚ö°', 'üí•', 'üí¢', 'üí¶', 'üí®', 'üåü',
    'üéâ', 'üéä', 'üéà', 'üéÅ', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', '‚öΩ', 'üèÄ'
  ];

  emojiBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    
    let emojiPicker = document.getElementById('emoji-picker');
    
    if (emojiPicker) {
      emojiPicker.classList.toggle('hidden');
      return;
    }
    
    // Crear picker si no existe
    const picker = document.createElement('div');
    picker.id = 'emoji-picker';
    picker.className = 'emoji-picker';
    
    const grid = document.createElement('div');
    grid.className = 'emoji-grid';
    
    emojis.forEach(emoji => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'emoji-item';
      btn.textContent = emoji;
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        insertEmoji(emoji);
      });
      grid.appendChild(btn);
    });
    
    picker.appendChild(grid);
    
    // Insertar despu√©s del textarea wrapper
    captionInput?.parentElement?.appendChild(picker);
  });

  function insertEmoji(emoji: string) {
    if (!captionInput) return;
    
    const start = captionInput.selectionStart;
    const end = captionInput.selectionEnd;
    const text = captionInput.value;
    
    captionInput.value = text.substring(0, start) + emoji + text.substring(end);
    captionInput.selectionStart = captionInput.selectionEnd = start + emoji.length;
    captionInput.focus();
    
    // Actualizar contador
    const event = new Event('input', { bubbles: true });
    captionInput.dispatchEvent(event);
    
    // Cerrar picker
    const picker = document.getElementById('emoji-picker');
    if (picker) picker.classList.add('hidden');
  }

  // Cerrar emoji picker al hacer clic fuera
  document.addEventListener('click', (e) => {
    const picker = document.getElementById('emoji-picker');
    if (picker && !picker.contains(e.target as Node) && e.target !== emojiBtn) {
      picker.classList.add('hidden');
    }
  });

  // ============================================================
  // üè∑Ô∏è ETIQUETAS
  // ============================================================
  tagsBtn?.addEventListener('click', () => {
    tagsInputDiv?.classList.toggle('hidden');
    tagText?.focus();
  });

  tagText?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const tag = (e.target as HTMLInputElement).value.trim().replace(/^#/, '');
      
      if (!tag) return;
      
      if (selectedTags.length >= 10) {
        showToast('M√°ximo 10 etiquetas', 'error');
        return;
      }

      if (!selectedTags.includes(tag)) {
        selectedTags.push(tag);
        addTagChip(tag);
        (e.target as HTMLInputElement).value = '';
        console.log('üè∑Ô∏è Tag agregado:', tag);
      }
    }
  });

  function addTagChip(tag: string) {
    const chip = document.createElement('span');
    chip.className = 'tag-chip';
    chip.dataset.tag = tag;
    
    chip.innerHTML = `
      #${tag}
      <button type="button" class="remove-tag" data-tag="${tag}">√ó</button>
    `;
    
    const removeBtn = chip.querySelector('.remove-tag');
    removeBtn?.addEventListener('click', () => {
      selectedTags = selectedTags.filter(t => t !== tag);
      chip.remove();
      console.log('üóëÔ∏è Tag removido:', tag);
    });

    tagsContainer?.appendChild(chip);
  }

  // ============================================================
// üì§ PUBLICAR POST 
// ============================================================
let isSubmitting = false;

form?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!publishBtn || isSubmitting) return;
  
  isSubmitting = true;
  publishBtn.disabled = true;
  const originalHTML = publishBtn.innerHTML;
  publishBtn.innerHTML = `
    <svg class="spinner" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10" opacity="0.25"/>
      <path d="M12 2a10 10 0 0110 10" opacity="0.75"/>
    </svg>
    Publicando...
  `;

  try {
  console.log('üì§ Enviando publicaci√≥n...');

  const formData = new FormData();
  
  // Caption
  const caption = captionInput?.value.trim();
  if (caption) formData.append('caption', caption);
  
  // Visibility
  const visibility = (document.getElementById('post-visibility') as HTMLSelectElement)?.value || 'public';
  formData.append('visibility', visibility);
  
  // Images
  console.log('üì∏ Archivos a enviar:', selectedFiles.length);
  selectedFiles.forEach((file, index) => {
    formData.append('images', file);
    console.log(`  - ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
  });
  
  // Location
  if (selectedLocation) {
    formData.append('location', JSON.stringify(selectedLocation));
  } else if (locationText?.value.trim()) {
    formData.append('location', locationText.value.trim());
  }
  
  // Tags
  if (selectedTags.length > 0) {
    formData.append('tags', JSON.stringify(selectedTags));
  }

  const response = await fetch(`${API_URL}/api/posts`, {
    method: 'POST',
    credentials: 'include',
    body: formData
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'Error al crear publicaci√≥n');
  }

  const result = await response.json();
  console.log('‚úÖ Post creado:', result);

  showToast('¬°Publicaci√≥n creada exitosamente!', 'success');
  closeModal();
  
  // Agregar post al feed
  try {
    const feedContainer = document.getElementById('posts-feed');
    
    if (result.post && feedContainer) {
      const existingPost = feedContainer.querySelector(`[data-post-id="${result.post._id}"]`);
      
      if (!existingPost) {
        console.log('üìù Creando HTML del post...');
        const postHTML = createPostHTML(result.post);
        
        console.log('‚ûï Insertando post en el feed...');
        feedContainer.insertAdjacentHTML('afterbegin', postHTML);
        
        setTimeout(() => {
          const newPost = feedContainer.querySelector(`[data-post-id="${result.post._id}"]`);
          if (newPost) {
            newPost.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }, 100);
        
        console.log('‚úÖ Post agregado al feed sin reload');
      } else {
        console.log('‚ÑπÔ∏è Post ya existe en el feed');
      }
    }
  } catch (htmlError) {
    console.error('‚ùå Error al crear HTML del post:', htmlError);
    // No lanzar el error, solo logearlo
    // El post se cre√≥ correctamente en el backend
  }

  // Actualizar contador
  const postsCountElement = document.querySelector('.posts-count');
  if (postsCountElement) {
    const currentCount = parseInt(postsCountElement.textContent || '0');
    postsCountElement.textContent = (currentCount + 1).toString();
  }

} catch (error) {
  console.error('‚ùå Error al publicar:', error);
  showToast((error as Error).message || 'Error al crear publicaci√≥n', 'error');
  
  publishBtn.disabled = false;
  publishBtn.innerHTML = originalHTML;
  isSubmitting = false;
} finally {
  setTimeout(() => {
    isSubmitting = false;
  }, 2000);
}
});

// ============================================================
// üé® FUNCI√ìN PARA CREAR HTML DEL POST (USANDO AUTOR REAL)
// ============================================================
function createPostHTML(post: any) {
  console.log('üé® Creando HTML para post:', post._id);

  const date = new Date(post.createdAt);
  const timeAgo = formatTimeAgo(date);

  // üîπ Datos de autor: primero el que viene populado del backend
  const author = post.author || {};
  const username =
    author.username ||
    localStorage.getItem('fe_username') ||
    'Usuario';

  const avatarUrl =
    author.profilePic ||
    localStorage.getItem('fe_profilePic') ||
    `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=72B340&color=fff`;

  // üîπ Im√°genes
  let mediaHTML = '';
  if (post.images && Array.isArray(post.images) && post.images.length > 0) {
    mediaHTML = `
      <div class="post-media">
        ${post.images
          .map((img: string) => `<img src="${img}" alt="Imagen del post" class="post-image" />`)
          .join('')}
      </div>
    `;
  }

  // üîπ Ubicaci√≥n
  let locationHTML = '';
  if (post.location) {
    const loc =
      typeof post.location === 'string'
        ? post.location
        : (post.location.city || post.location.name || '');
    if (loc) {
      locationHTML = `
        <div class="post-location">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <span>${escapeHTML(loc)}</span>
        </div>
      `;
    }
  }

  // üîπ Tags
  let tagsHTML = '';
  if (post.tags && post.tags.length > 0) {
    tagsHTML = `
      <div class="post-tags">
        ${post.tags.map((tag: string) => `<span class="tag">#${escapeHTML(tag)}</span>`).join(' ')}
      </div>
    `;
  }

  // üîπ Visibilidad
  let visibilityIcon = '';
  if (post.visibility === 'private') visibilityIcon = 'üîí';
  else if (post.visibility === 'followers') visibilityIcon = 'üë•';

  const html = `
    <article class="post-card fade-in" data-post-id="${post._id}">
      <header class="post-header">
        <div class="author-info">
          <img src="${avatarUrl}" alt="${escapeHTML(username)}" class="author-avatar" />
          <div class="author-details">
            <h3 class="author-name">${escapeHTML(username)} ${visibilityIcon}</h3>
            <span class="post-time">${timeAgo}</span>
          </div>
        </div>
        <button class="options-btn" title="Opciones">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
            <circle cx="12" cy="5" r="1.5"/>
            <circle cx="12" cy="12" r="1.5"/>
            <circle cx="12" cy="19" r="1.5"/>
          </svg>
        </button>
      </header>

      <div class="post-content">
        ${post.caption ? `<p class="caption">${escapeHTML(post.caption).replace(/\n/g, '<br>')}</p>` : ''}
        ${mediaHTML}
        ${locationHTML}
        ${tagsHTML}
      </div>

      <footer class="post-footer">
        <div class="post-actions">
          <button class="like-btn" data-post-id="${post._id}">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
            </svg>
            <span>${post.likes?.length || 0}</span>
          </button>
          <button class="comment-btn" data-post-id="${post._id}">
            üí¨ <span>${post.comments?.length || 0}</span>
          </button>
          <button class="share-btn" data-post-id="${post._id}">
            üîó Compartir
          </button>
        </div>
      </footer>
    </article>
  `;

  console.log('‚úÖ HTML del post creado con autor real');
  return html;
}

// ============================================================
// üõ°Ô∏è ESCAPE HTML
// ============================================================
function escapeHTML(text: string): string {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================================
// ‚è∞ FORMATEAR TIEMPO
// ============================================================
function formatTimeAgo(date: Date): string {
  const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000);
  
  const intervals: Record<string, number> = {
    a√±o: 31536000,
    mes: 2592000,
    semana: 604800,
    d√≠a: 86400,
    hora: 3600,
    minuto: 60
  };
  
  for (const [name, value] of Object.entries(intervals)) {
    const interval = Math.floor(seconds / value);
    if (interval >= 1) {
      return `hace ${interval} ${name}${interval > 1 ? 's' : ''}`;
    }
  }
  
  return 'justo ahora';
}

  // ============================================================
  // üé® EVENT LISTENERS
  // ============================================================
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);

  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });

  // ============================================================
  // üîî MOSTRAR TOAST
  // ============================================================
  function showToast(message: string, type: string = 'info') {
    const toast = document.getElementById('toast');
    const toastIcon = toast?.querySelector('.toast-icon');
    const toastMessage = toast?.querySelector('.toast-message');
    
    if (!toast || !toastIcon || !toastMessage) {
      console.log(`Toast: [${type}] ${message}`);
      return;
    }
    
    const icons: Record<string, string> = {
      success: '‚úì',
      error: '‚úï',
      info: '‚Ñπ'
    };
    
    toastIcon.textContent = icons[type] || icons.info;
    toastMessage.textContent = message;
    toast.className = `toast-notification ${type}`;
    toast.classList.remove('hidden');
    
    setTimeout(() => {
      toast.classList.add('hidden');
    }, 4000);
  }

  // ============================================================
  // üåç EXPONER FUNCI√ìN GLOBAL
  // ============================================================
  (window as any).openPostModal = openModal;
  
  console.log('‚úÖ PostModal script cargado');
</script>

<style>
  /* ===== VARIABLES ===== */
  :global(:root) {
    --primary: #687450;
    --primary-dark: #5a6444;
    --secondary: #425638;
    --accent: #8a9b6f;
    --success: #687450;
    --error: #d84315;
    --dark: #1f2937;
    --gray: #6b7280;
    --gray-light: #f5f5f3;
    --border: #e5e7e3;
    --white: #ffffff;
    --shadow-sm: 0 1px 3px rgba(66, 86, 56, 0.1);
    --shadow-md: 0 4px 6px rgba(66, 86, 56, 0.15);
    --shadow-lg: 0 10px 15px rgba(66, 86, 56, 0.2);
    --shadow-xl: 0 25px 50px -12px rgba(66, 86, 56, 0.4);
    --radius: 16px;
    --radius-sm: 10px;
    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ===== MODAL OVERLAY ===== */
  :global(.modal-overlay) {
    position: fixed;
    inset: 0;
    background: linear-gradient(
      135deg,
      rgba(104, 116, 80, 0.15) 0%,
      rgba(0, 0, 0, 0.85) 100%
    );
    backdrop-filter: blur(12px) saturate(150%);
    -webkit-backdrop-filter: blur(12px) saturate(150%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
    animation: overlayFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  :global(.modal-overlay.hidden) {
    display: none;
  }

  @keyframes overlayFadeIn {
    from {
      opacity: 0;
      backdrop-filter: blur(0px);
    }
    to {
      opacity: 1;
      backdrop-filter: blur(12px);
    }
  }

  /* ===== MODAL CONTAINER ===== */
  :global(.modal-container) {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    max-width: 650px;
    width: 100%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1px solid rgba(255, 255, 255, 0.8);
  }

  @keyframes modalSlideUp {
    from {
      opacity: 0;
      transform: translateY(60px) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  :global(.modal-container::before) {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
    opacity: 0.8;
  }

  /* ===== HEADER ===== */
  :global(.modal-header) {
    padding: 24px 28px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    background: linear-gradient(180deg, rgba(104, 116, 80, 0.03) 0%, transparent 100%);
  }

  :global(.modal-title) {
    font-size: 22px;
    font-weight: 700;
    color: var(--dark);
    margin: 0;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  :global(.modal-close) {
    background: var(--gray-light);
    border: 1px solid var(--border);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--gray);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  :global(.modal-close::before) {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    opacity: 0;
    transition: opacity 0.3s;
  }

  :global(.modal-close:hover) {
    border-color: var(--primary);
    transform: rotate(90deg);
  }

  :global(.modal-close:hover::before) {
    opacity: 0.1;
  }

  :global(.modal-close svg) {
    position: relative;
    z-index: 1;
  }

  /* ===== BODY ===== */
  :global(.modal-body) {
    padding: 28px;
    overflow-y: auto;
    flex: 1;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) var(--gray-light);
  }

  /* ===== USER INFO ===== */
  :global(.user-info) {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 24px;
    padding: 16px;
    background: linear-gradient(135deg, rgba(104, 116, 80, 0.05) 0%, rgba(66, 86, 56, 0.05) 100%);
    border-radius: var(--radius-sm);
    border: 1px solid rgba(104, 116, 80, 0.1);
  }

  :global(.modal-avatar) {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary);
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(104, 116, 80, 0.3);
  }

  :global(.user-details) {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1;
  }

  :global(.username) {
    font-weight: 700;
    font-size: 16px;
    color: var(--dark);
  }

  :global(.privacy-select) {
    background: var(--white);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    outline: none;
    transition: var(--transition);
    width: fit-content;
    box-shadow: var(--shadow-sm);
  }

  :global(.privacy-select:hover) {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(104, 116, 80, 0.1);
  }

  :global(.privacy-select:focus) {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(104, 116, 80, 0.15);
  }

  /* ===== POST INPUT ===== */
  :global(.post-input-wrapper) {
    position: relative;
    margin-bottom: 20px;
  }

  :global(.post-textarea) {
    width: 100%;
    min-height: 140px;
    max-height: 320px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 18px;
    padding-bottom: 40px;
    font-size: 16px;
    font-family: inherit;
    line-height: 1.6;
    resize: vertical;
    outline: none;
    transition: var(--transition);
    background: var(--white);
  }

  :global(.post-textarea:focus) {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(104, 116, 80, 0.1);
    transform: translateY(-1px);
  }

  :global(.post-textarea::placeholder) {
    color: var(--gray);
    opacity: 0.7;
  }

  :global(.char-counter) {
    position: absolute;
    bottom: 14px;
    right: 18px;
    font-size: 13px;
    color: var(--gray);
    font-weight: 600;
    pointer-events: none;
    padding: 4px 10px;
    background: var(--gray-light);
    border-radius: 12px;
    transition: var(--transition);
  }

  :global(.char-counter.warning) {
    color: var(--error);
    background: rgba(216, 67, 21, 0.1);
  }

  /* ===== MEDIA PREVIEW ===== */
  :global(.media-preview) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 14px;
    margin-bottom: 20px;
    padding: 16px;
    background: var(--gray-light);
    border-radius: var(--radius-sm);
    border: 2px dashed var(--border);
  }

  :global(.media-preview:empty) {
    display: none;
  }

  :global(.media-preview:not(:empty)) {
    border-style: solid;
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(104, 116, 80, 0.03) 0%, rgba(66, 86, 56, 0.03) 100%);
  }

  :global(.media-item) {
    position: relative;
    aspect-ratio: 1;
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--white);
    border: 2px solid var(--border);
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
  }

  :global(.media-item:hover) {
    transform: scale(1.05) rotate(1deg);
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
    z-index: 10;
  }

  :global(.media-item img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  :global(.remove-media) {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(216, 67, 21, 0.95);
    border: 2px solid var(--white);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    z-index: 20;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  :global(.remove-media:hover) {
    background: var(--error);
    transform: scale(1.15) rotate(90deg);
  }

  :global(.media-number) {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: var(--white);
    padding: 6px 10px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 2px solid var(--white);
  }

  /* ===== ACTION BUTTONS ===== */
  :global(.post-actions-bar) {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  :global(.action-btn) {
    background: linear-gradient(135deg, rgba(104, 116, 80, 0.08) 0%, rgba(66, 86, 56, 0.08) 100%);
    border: 2px solid var(--border);
    padding: 14px 16px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 700;
    color: var(--gray);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  :global(.action-btn::before) {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    opacity: 0;
    transition: opacity 0.3s;
  }

  :global(.action-btn:hover) {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(104, 116, 80, 0.2);
  }

  :global(.action-btn:hover::before) {
    opacity: 0.1;
  }

  :global(.action-btn svg) {
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }

  :global(.action-btn span) {
    position: relative;
    z-index: 1;
  }

  /* ===== LOCATION & TAGS ===== */
  :global(.location-input),
  :global(.tags-input) {
    margin-bottom: 20px;
    padding: 18px;
    background: linear-gradient(135deg, rgba(104, 116, 80, 0.03) 0%, rgba(66, 86, 56, 0.03) 100%);
    border-radius: var(--radius-sm);
    border: 2px solid var(--border);
    transition: var(--transition);
    position: relative;
  }

  :global(.location-input:hover),
  :global(.tags-input:hover) {
    border-color: var(--primary);
  }

  :global(.location-input) {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  :global(.location-suggestions) {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: var(--white);
    border: 2px solid var(--primary);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-lg);
    max-height: 250px;
    overflow-y: auto;
    z-index: 100;
    animation: slideDown 0.2s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  :global(.location-suggestion-item) {
    width: 100%;
    background: none;
    border: none;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  :global(.location-suggestion-item:last-child) {
    border-bottom: none;
  }

  :global(.location-suggestion-item:hover) {
    background: linear-gradient(135deg, rgba(104, 116, 80, 0.05) 0%, rgba(66, 86, 56, 0.05) 100%);
  }

  :global(.location-suggestion-item svg) {
    color: var(--primary);
    flex-shrink: 0;
  }

  :global(.location-suggestion-text) {
    flex: 1;
    min-width: 0;
  }

  :global(.location-name) {
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  :global(.location-detail) {
    font-size: 12px;
    color: var(--gray);
    margin-top: 2px;
  }

  :global(.location-field),
  :global(.tag-field) {
    flex: 1;
    background: var(--white);
    border: 2px solid var(--border);
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    outline: none;
    transition: var(--transition);
  }

  :global(.location-field:focus),
  :global(.tag-field:focus) {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(104, 116, 80, 0.1);
    transform: translateY(-1px);
  }

  :global(.remove-location) {
    background: var(--error);
    border: 2px solid var(--white);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 24px;
    color: var(--white);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
  }

  :global(.remove-location:hover) {
    background: #ba2d0b;
    transform: scale(1.1) rotate(90deg);
  }

  /* ===== EMOJI PICKER ===== */
  :global(.emoji-picker) {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 0;
    right: 0;
    background: var(--white);
    border: 2px solid var(--primary);
    border-radius: var(--radius-sm);
    padding: 16px;
    box-shadow: var(--shadow-lg);
    z-index: 100;
    max-height: 280px;
    overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  :global(.emoji-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 4px;
  }

  :global(.emoji-item) {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1;
  }

  :global(.emoji-item:hover) {
    background: linear-gradient(135deg, rgba(104, 116, 80, 0.1) 0%, rgba(66, 86, 56, 0.1) 100%);
    transform: scale(1.2);
  }

  :global(.emoji-picker::-webkit-scrollbar) {
    width: 8px;
  }

  :global(.emoji-picker::-webkit-scrollbar-track) {
    background: var(--gray-light);
    border-radius: 4px;
  }

  :global(.emoji-picker::-webkit-scrollbar-thumb) {
    background: var(--primary);
    border-radius: 4px;
  }

  /* ===== TAGS ===== */
  :global(.tags-container) {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 12px;
  }

  :global(.tags-container:empty) {
    margin-bottom: 0;
  }

  :global(.tag-chip) {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: var(--white);
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition);
    box-shadow: 0 4px 12px rgba(104, 116, 80, 0.3);
  }

  :global(.tag-chip:hover) {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 16px rgba(104, 116, 80, 0.4);
  }

  :global(.remove-tag) {
    background: rgba(255, 255, 255, 0.25);
    border: none;
    color: var(--white);
    font-size: 18px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    font-weight: 700;
  }

  :global(.remove-tag:hover) {
    background: rgba(255, 255, 255, 0.5);
    transform: rotate(90deg) scale(1.2);
  }

  /* ===== FOOTER ===== */
  :global(.modal-footer) {
    padding: 20px 28px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: linear-gradient(180deg, transparent 0%, rgba(104, 116, 80, 0.03) 100%);
    flex-shrink: 0;
  }

  :global(.btn-cancel) {
    background: var(--white);
    border: 2px solid var(--border);
    padding: 12px 24px;
    border-radius: var(--radius-sm);
    font-weight: 700;
    font-size: 15px;
    color: var(--gray);
    cursor: pointer;
    transition: var(--transition);
  }

  :global(.btn-cancel:hover) {
    background: var(--gray-light);
    border-color: var(--gray);
    color: var(--dark);
    transform: translateY(-1px);
  }

  :global(.btn-publish) {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border: none;
    padding: 12px 28px;
    border-radius: var(--radius-sm);
    font-weight: 700;
    font-size: 15px;
    color: var(--white);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: var(--transition);
    box-shadow: 0 6px 20px rgba(104, 116, 80, 0.4);
    position: relative;
    overflow: hidden;
  }

  :global(.btn-publish::before) {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }

  :global(.btn-publish:hover:not(:disabled)::before) {
    width: 300px;
    height: 300px;
  }

  :global(.btn-publish:hover:not(:disabled)) {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 8px 24px rgba(104, 116, 80, 0.5);
  }

  :global(.btn-publish:active:not(:disabled)) {
    transform: translateY(-1px) scale(1);
  }

  :global(.btn-publish:disabled) {
    opacity: 0.6;
    cursor: not-allowed;
    box-shadow: none;
  }

  :global(.btn-publish svg),
  :global(.btn-publish span) {
    position: relative;
    z-index: 1;
  }

  /* ===== SPINNER ===== */
  :global(.spinner) {
    animation: rotate 1s linear infinite;
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  :global(.btn-publish:disabled .spinner) {
    animation: rotate 1s linear infinite, pulse 2s ease-in-out infinite;
  }

  /* ===== HIDDEN ===== */
  :global(.hidden) {
    display: none !important;
  }

  /* ===== SCROLLBAR PREMIUM ===== */
  :global(.modal-body::-webkit-scrollbar) {
    width: 10px;
  }

  :global(.modal-body::-webkit-scrollbar-track) {
    background: var(--gray-light);
    border-radius: 10px;
  }

  :global(.modal-body::-webkit-scrollbar-thumb) {
    background: linear-gradient(180deg, var(--primary), var(--secondary));
    border-radius: 10px;
    border: 2px solid var(--gray-light);
  }

  :global(.modal-body::-webkit-scrollbar-thumb:hover) {
    background: linear-gradient(180deg, var(--primary-dark), var(--secondary));
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 700px) {
    :global(.modal-overlay) {
      padding: 0;
    }

    :global(.modal-container) {
      max-height: 100vh;
      max-width: 100%;
      border-radius: 0;
      animation: modalSlideUpMobile 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes modalSlideUpMobile {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    :global(.modal-header),
    :global(.modal-footer) {
      padding: 18px 20px;
    }

    :global(.modal-body) {
      padding: 24px 20px;
    }

    :global(.post-actions-bar) {
      grid-template-columns: 1fr;
    }

    :global(.action-btn) {
      padding: 16px;
    }

    :global(.action-btn span) {
      display: inline;
    }

    :global(.media-preview) {
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px;
      padding: 12px;
    }

    :global(.user-info) {
      padding: 14px;
    }

    :global(.modal-avatar) {
      width: 48px;
      height: 48px;
    }
  }

  /* ===== DARK MODE ===== */
  @media (prefers-color-scheme: dark) {
    :global(.modal-container) {
      background: #1f2937;
      border-color: #374151;
    }

    :global(.modal-header),
    :global(.modal-footer) {
      background: #111827;
      border-color: #374151;
    }

    :global(.modal-title),
    :global(.username) {
      color: #f9fafb;
    }

    :global(.post-textarea),
    :global(.location-field),
    :global(.tag-field),
    :global(.privacy-select) {
      background: #111827;
      border-color: #374151;
      color: #f9fafb;
    }

    :global(.action-btn),
    :global(.user-info),
    :global(.location-input),
    :global(.tags-input) {
      background: #111827;
      border-color: #374151;
    }

    :global(.btn-cancel) {
      background: #1f2937;
      border-color: #374151;
      color: #9ca3af;
    }

    :global(.btn-cancel:hover) {
      background: #374151;
      color: #f9fafb;
    }

    :global(.media-preview) {
      background: #111827;
      border-color: #374151;
    }

    :global(.media-item) {
      background: #1f2937;
      border-color: #374151;
    }

    :global(.emoji-picker),
    :global(.location-suggestions) {
      background: #1f2937;
      border-color: #374151;
    }
  }

  /* ===== FOCUS VISIBLE ===== */
  :global(*:focus-visible) {
    outline: 3px solid rgba(104, 116, 80, 0.5);
    outline-offset: 3px;
  }

  /* ===== TRANSICIONES GLOBALES ===== */
  :global(*) {
    transition-property: background-color, border-color, color, transform, box-shadow, opacity;
    transition-duration: 0.2s;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ===== ANIMACI√ìN FADE IN PARA NUEVO POST ===== */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  :global(.post.fade-in) {
    animation: fadeIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
  }

  :global(.post.fade-in::before) {
    content: '';
    position: absolute;
    inset: -4px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius: var(--radius);
    opacity: 0.15;
    animation: highlightPulse 2s ease-out;
    pointer-events: none;
    z-index: -1;
  }

  @keyframes highlightPulse {
    0% {
      opacity: 0.3;
      transform: scale(1.02);
    }
    100% {
      opacity: 0;
      transform: scale(1);
    }
  }
</style>
