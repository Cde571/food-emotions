---
// Header.astro - Componente din√°mico con autenticaci√≥n
---

<header id="header-nav" class="fixed w-screen py-1 z-40 top-0 px-8 lg:px-0">
  <div class="grid grid-cols-3 max-w-7xl mx-auto items-center justify-between">
    <a href="/" class="col-span-1 flex items-center">
      <img 
        src="/img/chatbot.png" 
        alt="FoodEmotions Logo" 
        class="h-10 w-auto md:h-12 lg:h-14 object-contain transition-transform duration-300 hover:scale-105"
      />
    </a>

    <nav class="col-span-1 justify-self-center">
      <ul id="nav-menu" class="flex gap-4 items-center text-white font-medium">
        </ul>
    </nav>

    <div id="auth-section" class="justify-self-end">
      </div>
  </div>
</header>

<script>
  // ‚úÖ Esta funci√≥n actualiza el header seg√∫n el estado de autenticaci√≥n
  async function updateHeader() {
    const navMenu = document.getElementById('nav-menu');
    const authSection = document.getElementById('auth-section');
    if (!navMenu || !authSection) return;

    try {
      // 1. Verificamos si hay sesi√≥n activa
      const statusRes = await fetch('http://localhost:3000/auth/status', { credentials: 'include' });
      const statusData = await statusRes.json();

      if (statusData.loggedIn) {
        // ‚úÖ Usuario autenticado
        // 2. PEDIMOS LOS DATOS COMPLETOS (FOTO, BIO, ETC) A /api/user/me
        let user = statusData.user || {}; // Fallback inicial
        
        try {
            const meRes = await fetch('http://localhost:3000/api/user/me', { credentials: 'include' });
            if (meRes.ok) {
                user = await meRes.json();
            }
        } catch (err) {
            console.error('Error obteniendo detalles completos del usuario:', err);
        }

        // Definimos la imagen y el nombre asegurando que no queden vac√≠os
        const userName = user.username || 'Usuario';
        // Si no hay profilePic, usamos ui-avatars con el nombre REAL del usuario
        const userImage = user.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=72B340&color=fff`;

        navMenu.innerHTML = `
          <li><a class="hover:underline" href="/Musica">üéµ Music section</a></li>
          <li><a class="hover:underline" href="/Comida">üçΩÔ∏è Food section</a></li>
          <li><a class="hover:underline" href="/Libros">üìö Book section</a></li>
          <li><a class="hover:underline" href="/Chatbot">ü§ñ Chatbot</a></li>
          <li><a class="hover:underline" href="/Dashboard">üìä Dashboard</a></li>
        `;

        authSection.innerHTML = `
          <div class="flex items-center gap-4">
            <a href="/Profile" class="flex items-center gap-2 hover:opacity-80 transition">
              <img 
                src="${userImage}" 
                alt="Profile" 
                class="w-10 h-10 rounded-full object-cover border-2 border-white"
              />
              <span class="text-white font-medium hidden md:inline">${userName}</span>
            </a>
            <button
              id="logout-btn"
              class="border rounded-full border-white px-4 py-2 hover:bg-white hover:text-black duration-300 transition"
            >
              Logout
            </button>
          </div>
        `;

        // L√≥gica de Logout
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', async () => {
            try {
              await fetch('http://localhost:3000/logout', {
                method: 'POST',
                credentials: 'include',
              });
              window.location.href = '/';
            } catch (error) {
              console.error('Error cerrando sesi√≥n:', error);
              alert('Error cerrando sesi√≥n');
            }
          });
        }
      } else {
        // ‚ùå Usuario NO autenticado
        navMenu.innerHTML = `
          <li><a class="hover:underline" href="/Social">Social</a></li>
          <li><a class="hover:underline" href="/Testimonials">Testimonials</a></li>
          <li><a class="hover:underline" href="/FAQ">FAQ</a></li>
          <li><a class="hover:underline" href="/Contact">Contact</a></li>
        `;

        authSection.innerHTML = `
          <a
            href="/Register"
            class="border rounded-full inline-block border-white px-4 py-2 hover:bg-white hover:text-black duration-300 transition"
          >
            Login
          </a>
        `;
      }
    } catch (error) {
      console.error('Error verificando sesi√≥n:', error);
      // Fallback en caso de error de red
      navMenu.innerHTML = `
        <li><a class="hover:underline" href="/Social">Social</a></li>
        <li><a class="hover:underline" href="/Testimonials">Testimonials</a></li>
        <li><a class="hover:underline" href="/FAQ">FAQ</a></li>
        <li><a class="hover:underline" href="/Contact">Contact</a></li>
      `;

      authSection.innerHTML = `
        <a
          href="/Register"
          class="border rounded-full inline-block border-white px-4 py-2 hover:bg-white hover:text-black duration-300 transition"
        >
          Login
        </a>
      `;
    }
  }

  updateHeader();
  document.addEventListener('astro:page-load', updateHeader);

  // üîπ Efecto de scroll (blur en el header)
  window.addEventListener('scroll', function () {
    const header = document.getElementById('header-nav');
    if (header) {
      if (window.scrollY > 50) {
        header.classList.add('fixed-blur');
      } else {
        header.classList.remove('fixed-blur');
      }
    }
  });
</script>

<style>
  header {
    background-color: #3b432b;
    color: white;
    transition: all 0.3s ease;
  }

  .fixed-blur {
    backdrop-filter: blur(10px);
    background-color: rgba(59, 67, 43, 0.8);
  }

  .hover\:underline:hover {
    text-decoration: underline;
  }

  img[alt="Profile"] {
    transition: transform 0.2s ease;
  }

  img[alt="Profile"]:hover {
    transform: scale(1.05);
  }

  @media (max-width: 768px) {
    .hidden.md\:inline {
      display: none;
    }
  }
</style>